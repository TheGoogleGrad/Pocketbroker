<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>PocketBroker ‚Äî Deal Analyzer</title>
<meta name="description" content="Fast CRE deal analysis in your pocket">
<meta name="theme-color" content="#0a0c10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PocketBroker">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="pocketbroker.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10;
    --surface: #12151c;
    --surface2: #1a1f2a;
    --border: #252b38;
    --border-bright: #3a4256;
    --accent: #4f8ef7;
    --accent2: #38d9a9;
    --accent3: #f7c948;
    --danger: #f76e6e;
    --text: #e8ecf4;
    --text2: #8892a4;
    --text3: #4f5a6e;
    --mono: 'DM Mono', monospace;
    --sans: 'DM Sans', sans-serif;
    --display: 'Syne', sans-serif;
  }

  [data-theme="light"] {
    --bg: #f0f2f7;
    --surface: #ffffff;
    --surface2: #e8eaf0;
    --border: #d0d5e0;
    --text: #1a1f2e;
    --text2: #4a5468;
    --text3: #9099ae;
  }
  [data-theme="light"] html,
  [data-theme="light"] body { background: #f0f2f7 !important; }
  [data-theme="light"] .field-prefix,
  [data-theme="light"] .field-suffix { background: #e8eaf0; }
  [data-theme="light"] .unit-num { background: #e0e3eb; }
  [data-theme="light"] .section-badge { background: #e0e3eb; color: var(--text2); }
  [data-theme="light"] .wf-row.total { background: #e8eaf0; }
  [data-theme="light"] .waterfall { background: #ffffff; }
  [data-theme="light"] .result-card { background: #ffffff; }
  [data-theme="light"] .pw-box { background: #ffffff; }
  [data-theme="light"] #pw-screen { background: #f0f2f7; }
  [data-theme="light"] .tabs { background: #ffffff; }
  [data-theme="light"] .header { background: #ffffff; }
  [data-theme="light"] .share-bar { background: linear-gradient(to top, #f0f2f7 70%, transparent); }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overscroll-behavior: none;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    font-family: var(--display);
    font-weight: 800;
    font-size: 20px;
    letter-spacing: -0.5px;
    color: var(--text);
  }
  .logo span { color: var(--accent); }
  .tagline {
    font-size: 11px;
    color: var(--text3);
    font-family: var(--mono);
    letter-spacing: 0.05em;
  }
  .reset-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .reset-btn:hover { border-color: var(--danger); color: var(--danger); }
  .theme-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    font-size: 15px;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    line-height: 1;
  }
  .theme-btn:hover { border-color: var(--accent); }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    gap: 0;
  }
  .tab {
    flex: 1;
    padding: 12px 8px;
    text-align: center;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 120px; width: 100%; }

  /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
  .panel { display: none; }
  .panel.active { display: block; }

  /* ‚îÄ‚îÄ SECTION ‚îÄ‚îÄ */
  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .section-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .section-title {
    font-family: var(--display);
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--text2);
  }
  .section-badge {
    font-family: var(--mono);
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--surface2);
    color: var(--text2);
  }

  /* ‚îÄ‚îÄ FIELD ‚îÄ‚îÄ */
  .field {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .field:last-child { border-bottom: none; }
  .field-label {
    flex: 1;
    font-size: 13px;
    color: var(--text2);
    font-weight: 400;
  }
  .field-label small {
    display: block;
    font-size: 11px;
    color: var(--text3);
    margin-top: 1px;
    font-family: var(--mono);
  }
  .field-input-wrap {
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.15s;
    min-width: 130px;
  }
  .field-input-wrap:focus-within { border-color: var(--accent); }
  .field-prefix, .field-suffix {
    padding: 0 10px;
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text3);
    background: var(--surface);
    height: 40px;
    display: flex;
    align-items: center;
    border-right: 1px solid var(--border);
    flex-shrink: 0;
  }
  .field-suffix { border-right: none; border-left: 1px solid var(--border); }
  .field-input-wrap input {
    background: #ffffff;
    border: none;
    outline: none;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 500;
    padding: 0 10px;
    height: 40px;
    width: 100%;
    min-width: 0;
  }
  .field-input-wrap input::placeholder { color: var(--text3); }
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }

  /* ‚îÄ‚îÄ UNIT ROWS ‚îÄ‚îÄ */
  .unit-row {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    display: grid;
    grid-template-columns: 22px 60px 74px 62px 62px 18px;
    gap: 4px;
    align-items: center;
  }
  .yr2-input {
    background: #ffffff;
    border: 1px solid rgba(56,217,169,0.25);
    border-radius: 6px;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 12px;
    padding: 6px 6px 6px 18px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
    height: 34px;
  }
  .yr2-input:focus { border-color: var(--accent2); }
  .yr3-input {
    background: #ffffff;
    border: 1px solid rgba(247,201,72,0.3);
    border-radius: 6px;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 11px;
    padding: 0 4px 0 18px;
    height: 34px;
    width: 100%;
    outline: none;
    transition: border-color 0.15s;
  }
  .yr3-input:focus { border-color: var(--accent3); }
  .yr3-input::placeholder { color: rgba(247,201,72,0.3); }
  .yr3-input:disabled { opacity: 0.4; background: var(--surface2); border-color: var(--border); color: var(--text3); }
  .yr2-input::placeholder { color: rgba(56,217,169,0.3); }
  .yr2-input:disabled { opacity: 0.4; background: var(--surface2); border-color: var(--border); color: var(--text3); }
  .global-increase-bar {
    padding: 10px 16px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .apply-all-label {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
  }
  .apply-all-label input[type=checkbox] { accent-color: var(--accent2); width: 14px; height: 14px; cursor: pointer; }
  .yr2-pct-wrap {
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    height: 30px;
  }
  .yr2-pct-wrap input {
    background: #ffffff;
    border: none;
    outline: none;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 600;
    padding: 0 6px;
    width: 52px;
    height: 30px;
  }
  .yr2-pct-wrap span {
    padding: 0 8px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    background: var(--surface2);
    height: 30px;
    display: flex;
    align-items: center;
    border-left: 1px solid var(--border);
  }
  .unit-row:last-child { border-bottom: none; }
  .unit-num {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .unit-input {
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 13px;
    padding: 6px 10px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }
  .unit-input:focus { border-color: var(--accent); }
  .unit-input::placeholder { color: var(--text3); }
  .unit-select {
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 10px;
    padding: 6px 28px 6px 10px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%234f5a6e' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    cursor: pointer;
    height: 34px;
  }
  .unit-select:focus { border-color: var(--accent); }
  .unit-select option { background: #ffffff; color: #1a1f2e; }
  .unit-remove {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    line-height: 1;
    transition: color 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
  }
  .unit-remove:hover { color: var(--danger); }

  .units-totals-row {
    display: grid;
    grid-template-columns: 24px 72px 82px 72px 72px 22px;
    gap: 5px;
    padding: 10px 12px;
    background: var(--surface2);
    border-top: 1px solid var(--border);
    align-items: center;
  }
  .units-totals-row span {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
  }
  @media (min-width: 768px) {
    .units-totals-row {
      grid-template-columns: 28px 1fr 1fr 1fr 1fr 24px !important;
      gap: 10px !important;
      padding: 10px 24px !important;
    }
  }
  .add-btn {
    width: 100%;
    padding: 12px;
    background: none;
    border: none;
    border-top: 1px solid var(--border);
    color: var(--accent);
    font-family: var(--mono);
    font-size: 12px;
    cursor: pointer;
    transition: background 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .add-btn:hover { background: var(--surface2); }

  /* ‚îÄ‚îÄ EXPENSES ‚îÄ‚îÄ */
  .expense-row {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    display: grid;
    grid-template-columns: 1fr 120px auto auto;
    gap: 8px;
    align-items: center;
  }
  .expense-row:last-child { border-bottom: none; }
  .expense-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  .toggle {
    width: 32px;
    height: 18px;
    background: var(--border);
    border-radius: 9px;
    position: relative;
    transition: background 0.15s;
    flex-shrink: 0;
  }
  .toggle.on { background: var(--accent2); }
  .toggle::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    background: white;
    border-radius: 50%;
    top: 3px;
    left: 3px;
    transition: transform 0.15s;
  }
  .toggle.on::after { transform: translateX(14px); }
  .expense-name {
    font-size: 13px;
    color: var(--text2);
  }
  .expense-name.off { color: var(--text3); text-decoration: line-through; }
  .expense-input {
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 13px;
    padding: 6px 10px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }
  .expense-input:focus { border-color: var(--accent); }
  .expense-type-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text3);
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 8px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
  }
  .expense-type-btn:hover { border-color: var(--accent); color: var(--accent); }
  .expense-remove {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 16px;
    width: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.15s;
  }
  .expense-remove:hover { color: var(--danger); }

  /* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
  .results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .result-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 12px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
    min-width: 0;
  }
  .result-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .result-card.blue::before { background: var(--accent); }
  .result-card.green::before { background: var(--accent2); }
  .result-card.gold::before { background: var(--accent3); }
  .result-card.red::before { background: var(--danger); }
  .result-label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 8px;
  }
  .result-value {
    font-family: var(--display);
    font-weight: 800;
    font-size: clamp(16px, 4.5vw, 26px);
    letter-spacing: -0.5px;
    line-height: 1;
    margin-bottom: 4px;
    word-break: break-word;
    overflow-wrap: break-word;
  }
  .result-card.blue .result-value { color: var(--accent); }
  .result-card.green .result-value { color: var(--accent2); }
  .result-card.gold .result-value { color: var(--accent3); }
  .result-card.red .result-value { color: var(--danger); }
  .result-sub {
    font-size: 11px;
    color: var(--text3);
    font-family: var(--mono);
  }

  /* ‚îÄ‚îÄ WATERFALL ‚îÄ‚îÄ */
  .waterfall {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 16px;
  }
  .wf-row {
    padding: 11px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .wf-row:last-child { border-bottom: none; }
  .wf-row.total {
    background: var(--surface2);
    font-weight: 600;
  }
  .wf-label { color: var(--text2); }
  .wf-label.indent { padding-left: 16px; color: var(--text3); font-size: 12px; }
  .wf-value { font-family: var(--mono); font-size: 13px; font-weight: 500; }
  .wf-value.neg { color: var(--danger); }
  .wf-value.pos { color: var(--accent2); }
  .wf-value.highlight { color: var(--accent); }

  /* ‚îÄ‚îÄ LOAN SECTION ‚îÄ‚îÄ */
  .loan-toggle-row {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
  }
  .loan-toggle-label {
    font-size: 13px;
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* ‚îÄ‚îÄ PROPERTY INFO ‚îÄ‚îÄ */
  .prop-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
  }
  .prop-field {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    border-right: 1px solid var(--border);
    background: #ffffff;
  }
  .prop-field:nth-child(even) { border-right: none; }
  .prop-field:nth-last-child(-n+2) { border-bottom: none; }
  .prop-field-label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 6px;
  }
  .prop-field-input {
    background: #ffffff;
    border: none;
    outline: none;
    color: #1a1f2e;
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 500;
    width: 100%;
  }
  .prop-field-input::placeholder { color: var(--text3); font-weight: 400; }

  /* ‚îÄ‚îÄ SHARE BTN ‚îÄ‚îÄ */
  .share-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 16px 20px;
    background: linear-gradient(to top, #0a0c10 70%, transparent);
    display: flex;
    gap: 10px;
    max-width: 600px;
    margin: 0 auto;
  }
  .calc-btn {
    flex: 1;
    padding: 14px;
    background: var(--accent);
    border: none;
    border-radius: 10px;
    color: white;
    font-family: var(--display);
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: opacity 0.15s;
    letter-spacing: 0.02em;
  }
  .calc-btn:active { opacity: 0.8; }
  .share-btn {
    padding: 14px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text2);
    font-family: var(--mono);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .share-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--accent2);
    color: var(--bg);
    font-family: var(--mono);
    font-size: 12px;
    padding: 10px 20px;
    border-radius: 8px;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 999;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty {
    text-align: center;
    padding: 48px 20px;
    color: var(--text3);
    font-size: 13px;
  }
  .empty-icon { font-size: 36px; margin-bottom: 12px; }
  .empty-title {
    font-family: var(--display);
    font-size: 16px;
    font-weight: 700;
    color: var(--text2);
    margin-bottom: 6px;
  }

  /* ‚îÄ‚îÄ HEADER COL LABELS ‚îÄ‚îÄ */
  .unit-header {
    padding: 6px 16px;
    display: grid;
    grid-template-columns: 22px 60px 74px 62px 62px 18px;
    gap: 6px;
  }
  .unit-header span {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text3);
  }

  .income-total-row {
    padding: 12px 16px;
    background: var(--surface2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--border);
  }
  .income-total-label {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text3);
  }
  .income-total-value {
    font-family: var(--mono);
    font-size: 15px;
    font-weight: 500;
    color: var(--accent2);
  }

  @media (min-width: 768px) {
    .main { max-width: 860px !important; width: 100% !important; }
    .section { width: 100% !important; }
    #units-list, .unit-header { width: 100% !important; }
    .unit-row {
      display: grid !important;
      grid-template-columns: 28px 1fr 1fr 1fr 1fr 24px !important;
      gap: 10px !important;
      padding: 10px 24px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }
    .unit-header {
      display: grid !important;
      grid-template-columns: 28px 1fr 1fr 1fr 1fr 24px !important;
      padding: 8px 24px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }
    .unit-input, .yr2-input, .yr3-input { font-size: 13px !important; width: 100% !important; }
    .unit-select { font-size: 12px !important; width: 100% !important; }
    .results-grid { grid-template-columns: repeat(3, 1fr) !important; }
    /* prop-grid stays 2-col on all sizes */
    .share-bar { padding: 12px 20px !important; }
  }

  @media (max-width: 380px) {
    .results-grid { grid-template-columns: 1fr; }
    .result-value { font-size: clamp(14px, 4vw, 22px); }
  }
  /* ‚îÄ‚îÄ PASSWORD SCREEN ‚îÄ‚îÄ */
  #pw-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 20px;
  }
  #pw-screen.hidden { display: none; }
  .pw-logo {
    font-family: var(--display);
    font-weight: 800;
    font-size: 26px;
    letter-spacing: -0.5px;
    margin-bottom: 6px;
    white-space: nowrap;
  }
  .pw-logo span { color: var(--accent); }
  .pw-tagline {
    font-family: var(--display);
    font-size: 9px;
    color: var(--text3);
    letter-spacing: 0.25em;
    text-transform: uppercase;
    margin-bottom: 24px;
  }
  .pw-box {
    width: 100%;
    max-width: 280px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .pw-box-inner { padding: 16px; }
  .pw-label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 10px;
  }
  .pw-input {
    width: 100%;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: #1a1f2e;
    font-family: var(--mono);
    font-size: 15px;
    font-weight: 500;
    padding: 12px 16px;
    outline: none;
    margin-bottom: 12px;
    transition: border-color 0.15s;
    -webkit-text-security: disc;
    letter-spacing: 0.1em;
  }
  .pw-input:focus { border-color: var(--accent); }
  .pw-input.error { border-color: var(--danger); animation: shake 0.3s ease; }
  .pw-btn {
    width: 100%;
    padding: 13px;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: white;
    font-family: var(--display);
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: opacity 0.15s;
    letter-spacing: 0.02em;
  }
  .pw-btn:active { opacity: 0.8; }
  .pw-error {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--danger);
    text-align: center;
    margin-top: 10px;
    min-height: 16px;
  }
  .pw-footer {
    margin-top: 48px;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    text-align: center;
    letter-spacing: 0.05em;
  }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ PASSWORD SCREEN ‚îÄ‚îÄ -->
<div id="pw-screen">
  <div class="pw-logo" style="margin-bottom:16px;">Pocket<span>Broker</span></div>
  <div style="width:220px;height:2px;background:linear-gradient(to right,transparent,#4f8ef7,#4f8ef7,transparent);box-shadow:0 0 6px 1px rgba(79,142,247,0.6);margin-bottom:16px;"></div>
  <div class="pw-tagline">deal analyzer ¬∑ members only</div>
  <div class="pw-box">
    <div class="pw-box-inner">
      <div class="pw-label">Enter Password</div>
      <input class="pw-input" id="pw-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        onkeydown="if(event.key==='Enter')checkPassword()" autocomplete="current-password" />
      <button class="pw-btn" onclick="checkPassword()">Unlock ‚Üí</button>
      <div class="pw-error" id="pw-error"></div>
    </div>
  </div>
  <div class="pw-footer">Access restricted ¬∑ PocketBroker<br>
  <span style="margin-top:6px;display:block;">Built by <span style="color:var(--accent);">@TheGoogleGrad</span></span>
</div>
</div>

<div class="header">
  <div>
    <div class="logo">Pocket<span>Broker</span></div>
    <div class="tagline">DEAL ANALYZER</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center;">
    <button class="theme-btn" id="theme-btn" onclick="toggleTheme()" title="Toggle light/dark mode">üåô</button>
    <button class="reset-btn" onclick="resetAll()">‚Ü∫ Reset</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('income')">Income</div>
  <div class="tab" onclick="switchTab('expenses')">Expenses</div>
  <div class="tab" onclick="switchTab('debt')">Debt</div>
  <div class="tab" onclick="switchTab('comps')">Comps</div>
  <div class="tab" onclick="switchTab('results')">Results</div>
</div>

<div class="main">

  <!-- ‚ïê‚ïê INCOME PANEL ‚ïê‚ïê -->
  <div class="panel active" id="panel-income">

    <div class="section">
      <div class="section-header">
        <div class="section-title">Property Info</div>
      </div>
      <div class="prop-grid">
        <div class="prop-field">
          <div class="prop-field-label">Address</div>
          <input class="prop-field-input" id="prop-address" placeholder="123 Main St" />
        </div>
        <div class="prop-field">
          <div class="prop-field-label">City</div>
          <input class="prop-field-input" id="prop-city" placeholder="Los Angeles" />
        </div>
        <div class="prop-field">
          <div class="prop-field-label">Zip Code</div>
          <input class="prop-field-input" id="prop-zip" placeholder="90210" type="number" />
        </div>
        <div class="prop-field">
          <div class="prop-field-label">State</div>
          <input class="prop-field-input" id="prop-state" placeholder="CA" maxlength="2" style="text-transform:uppercase;" />
        </div>
        <div class="prop-field" style="grid-column: span 2;">
          <div class="prop-field-label">Year Built</div>
          <input class="prop-field-input" id="prop-year" placeholder="1972" />
        </div>
        <div class="prop-field">
          <div class="prop-field-label">Building SF</div>
          <input class="prop-field-input" id="prop-bldg-sf" type="number" placeholder="4,500" oninput="calculate()" />
        </div>
        <div class="prop-field">
          <div class="prop-field-label">Land SF (Lot)</div>
          <input class="prop-field-input" id="prop-land-sf" type="number" placeholder="6,000" oninput="calculate()" />
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <div class="section-title">Rental Units</div>
        <div class="section-badge" id="unit-count-badge">0 units</div>
      </div>
      <div class="global-increase-bar" style="flex-direction:column;gap:8px;align-items:flex-start;">
        <div style="display:flex;align-items:center;gap:10px;width:100%;flex-wrap:wrap;">
          <div class="yr2-pct-wrap">
            <input type="number" id="global-yr2-pct" value="5" step="0.1" min="0" oninput="applyAllYr2()" />
            <span>% annual increase</span>
          </div>
        </div>
        <div style="display:flex;gap:16px;flex-wrap:wrap;">
          <label class="apply-all-label" style="color:var(--accent2);">
            <input type="checkbox" id="apply-all-yr2" onchange="applyAllYr2()" />
            Apply to Yr 2
          </label>
          <label class="apply-all-label" style="color:var(--accent3);">
            <input type="checkbox" id="apply-all-yr3" onchange="applyAllYr2()" />
            Apply to Yr 3
          </label>
        </div>
      </div>
      <div class="unit-header">
        <span></span>
        <span>Type</span>
        <span style="color:var(--text3);">Rent</span>
        <span style="color:var(--accent2);">Yr 2</span>
        <span id="yr3-header-label" style="color:var(--accent3);font-size:8px;">YR 3 PRO FORMA</span>
        <span></span>
      </div>
      <div id="units-list"></div>
      <div id="units-totals"></div>
      <button class="add-btn" onclick="addUnit()">Ôºã Add Unit</button>
    </div>

    <div class="section">
      <div class="section-header">
        <div class="section-title">Other Income</div>
      </div>
      <div class="field">
        <div class="field-label">
          Laundry Income
          <small>Monthly</small>
        </div>
        <div class="field-input-wrap">
          <div class="field-prefix">$</div>
          <input type="number" id="laundry-income" placeholder="0" oninput="calculate()" />
        </div>
      </div>
      <div class="field">
        <div class="field-label">
          Parking Income
          <small>Monthly</small>
        </div>
        <div class="field-input-wrap">
          <div class="field-prefix">$</div>
          <input type="number" id="parking-income" placeholder="0" oninput="calculate()" />
        </div>
      </div>
      <div class="field">
        <div class="field-label">
          Vacancy Rate
          <small>% of gross income</small>
        </div>
        <div class="field-input-wrap">
          <input type="number" id="vacancy-rate" value="5" placeholder="5" oninput="calculate()" />
          <div class="field-suffix">%</div>
        </div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê EXPENSES PANEL ‚ïê‚ïê -->
  <div class="panel" id="panel-expenses">

    <div class="section">
      <div class="section-header">
        <div class="section-title">Default Expenses</div>
        <div class="section-badge">Toggle on/off</div>
      </div>
      <div id="default-expenses-list"></div>
    </div>

    <div class="section">
      <div class="section-header">
        <div class="section-title">Custom Expenses</div>
        <div class="section-badge" id="custom-count">0 added</div>
      </div>
      <div id="custom-expenses-list"></div>
      <button class="add-btn" onclick="addCustomExpense()">Ôºã Add Custom Expense</button>
    </div>

  </div>

  <!-- ‚ïê‚ïê DEBT PANEL ‚ïê‚ïê -->
  <div class="panel" id="panel-debt">

    <div class="section">
      <div class="section-header">
        <div class="section-title">Target Price</div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--accent2);">‚Üï tweak to value</div>
      </div>
      <div style="padding:12px 16px;display:flex;align-items:center;gap:10px;background:var(--surface);">
        <div style="font-family:var(--mono);font-size:20px;color:var(--text3);">$</div>
        <input type="text" id="prop-price"
          placeholder="1,200,000"
          oninput="formatPriceInput(this)"
          inputmode="numeric"
          style="flex:1;background:none;border:none;outline:none;font-family:var(--display);font-weight:800;font-size:28px;letter-spacing:-1px;color:var(--accent);min-width:0;" />
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <div class="section-title">Loan Assumptions</div>
        <div class="loan-toggle-row" style="padding:0;border:none;" onclick="toggleDebt()">
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="toggle" id="debt-toggle"></div>
            <span style="font-size:12px;color:var(--text3);font-family:var(--mono);">Include debt service</span>
          </div>
        </div>
      </div>
      <div id="debt-fields">
        <div class="field">
          <div class="field-label">Down Payment<small>% of purchase price</small></div>
          <div class="field-input-wrap">
            <input type="number" id="down-pct" value="25" placeholder="25" oninput="calculate()" />
            <div class="field-suffix">%</div>
          </div>
        </div>
        <div class="field" style="background:var(--surface2);">
          <div class="field-label">
            Down Payment Amount
            <small>Cash required at close</small>
          </div>
          <div style="font-family:var(--mono);font-size:15px;font-weight:600;color:var(--accent3);" id="down-amt-display">‚Äî</div>
        </div>
        <div class="field" style="background:var(--surface2);">
          <div class="field-label">
            Loan Balance
            <small>After down payment</small>
          </div>
          <div style="font-family:var(--mono);font-size:15px;font-weight:600;color:var(--accent);" id="loan-bal-display">‚Äî</div>
        </div>
        <div class="field">
          <div class="field-label">Interest Rate<small>Annual</small></div>
          <div class="field-input-wrap">
            <input type="number" id="int-rate" value="6.5" step="0.1" placeholder="6.5" oninput="calculate()" />
            <div class="field-suffix">%</div>
          </div>
        </div>
        <div class="field">
          <div class="field-label">Amortization<small>Years</small></div>
          <div class="field-input-wrap">
            <input type="number" id="amort-years" value="30" placeholder="30" oninput="calculate()" />
            <div class="field-suffix">yrs</div>
          </div>
        </div>
        <div class="field" style="background:var(--surface2);">
          <div class="field-label">
            Monthly Payment
            <small>Principal + Interest</small>
          </div>
          <div style="font-family:var(--mono);font-size:15px;font-weight:600;color:var(--accent3);" id="monthly-payment-display">‚Äî</div>
        </div>
        <div class="field" style="background:var(--surface2);">
          <div class="field-label">
            Annual Debt Service
            <small>Total yearly payments</small>
          </div>
          <div style="font-family:var(--mono);font-size:15px;font-weight:600;color:var(--accent3);" id="annual-debt-display">‚Äî</div>
        </div>
        <div class="field" style="background:var(--surface2);border-bottom:none;">
          <div class="field-label">
            DSCR
            <small>Debt Service Coverage Ratio</small>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="font-family:var(--mono);font-size:15px;font-weight:600;" id="dscr-display">‚Äî</div>
            <div id="dscr-badge" style="font-family:var(--mono);font-size:10px;padding:3px 8px;border-radius:4px;display:none;"></div>
          </div>
        </div>
        <div style="padding:12px 16px;background:var(--surface2);border-top:1px solid var(--border);">
          <div style="font-family:var(--mono);font-size:10px;color:var(--text3);line-height:1.6;">
            DSCR = NOI √∑ Annual Debt Service<br>
            <span style="color:var(--accent2);">‚â• 1.25x</span> ‚Äî lender approved &nbsp;¬∑&nbsp;
            <span style="color:var(--accent3);">1.00‚Äì1.24x</span> ‚Äî tight &nbsp;¬∑&nbsp;
            <span style="color:var(--danger);">&lt; 1.00x</span> ‚Äî negative coverage
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê RESULTS PANEL ‚ïê‚ïê -->
  <div class="panel" id="panel-comps">
    <div class="section">
      <div class="section-header">
        <div class="section-title">Market Comps</div>
        <div class="section-badge" id="comps-count-badge">0 comps</div>
      </div>
      <div style="padding:12px 16px 4px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);">Add comparable sales to benchmark this deal</div>
        <button class="add-btn" style="margin:0;padding:8px 14px;font-size:11px;" onclick="addComp()">Ôºã Add Comp</button>
      </div>

      <!-- Comps header -->
      <div id="comps-header" style="display:none;padding:6px 16px;background:var(--surface2);border-top:1px solid var(--border);border-bottom:1px solid var(--border);">
        <div style="display:grid;grid-template-columns:1fr 60px 80px 60px 24px;gap:6px;align-items:center;margin-bottom:4px;">
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);">Address</span>
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);">Units</span>
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);">Sale Price</span>
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent2);">Cap</span>
          <span></span>
        </div>
        <div style="display:grid;grid-template-columns:80px 80px 1fr;gap:6px;">
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);">Bldg SF</span>
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);">Land SF</span>
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);">Calculated</span>
        </div>
      </div>

      <div id="comps-list"></div>

      <!-- Comps summary -->
      <div id="comps-summary" style="display:none;"></div>
    </div>

    <!-- Notes -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Deal Notes</div>
      </div>
      <div style="padding:12px 16px;">
        <textarea id="deal-notes" placeholder="Add notes about this deal, market conditions, broker contact, etc..."
          style="width:100%;min-height:120px;background:#ffffff;border:1px solid var(--border);border-radius:8px;
                 padding:12px;font-family:var(--mono);font-size:12px;color:#1a1f2e;resize:vertical;outline:none;
                 transition:border-color 0.15s;line-height:1.5;"
          onfocus="this.style.borderColor='var(--accent)'"
          onblur="this.style.borderColor='var(--border)'"></textarea>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-results">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;margin:0 0 16px 0;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;">
      <div style="font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);">Analysis Date</div>
      <input type="month" id="analysis-date"
        style="background:none;border:none;outline:none;font-family:var(--mono);font-size:13px;color:var(--accent);text-align:right;cursor:pointer;" />
    </div>
    <div id="results-content">
      <div class="empty">
        <div class="empty-icon">üè¢</div>
        <div class="empty-title">No data yet</div>
        Add units on the Income tab and set a price on the Debt tab
      </div>
    </div>
  </div>

</div>

<!-- Share bar -->
<div class="share-bar" style="flex-wrap:wrap;gap:8px;">
  <button class="calc-btn" id="next-btn" onclick="goNext()" style="flex:1;min-width:100px;">‚Üí Next</button>
  <button class="share-btn" onclick="copySnapshot()" style="padding:14px 10px;font-size:11px;">‚¨° Copy</button>
  <button class="share-btn" onclick="exportExcel()" style="padding:14px 10px;font-size:11px;border-color:rgba(56,217,169,0.4);color:var(--accent2);">‚¨á XLS</button>
  <button class="share-btn" onclick="exportPDF()" style="padding:14px 10px;font-size:11px;border-color:rgba(247,201,72,0.4);color:var(--accent3);">‚¨á PDF</button>
  <button class="share-btn" onclick="saveDeal()" style="padding:14px 10px;font-size:11px;border-color:rgba(79,142,247,0.4);color:var(--accent);">üíæ Save</button>
  <label class="share-btn" style="padding:14px 10px;font-size:11px;border-color:rgba(56,217,169,0.4);color:var(--accent2);cursor:pointer;">
    üìÇ Load<input type="file" accept=".json" onchange="loadDeal(event)" style="display:none;" />
  </label>
</div>

<div class="toast" id="toast"></div>
<div style="text-align:center;padding:8px;font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:0.05em;padding-bottom:100px;">
  Built by <span style="color:var(--accent);">@TheGoogleGrad</span>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let units = [];
let unitId = 0;
let debtEnabled = false;

const defaultExpenses = [
  { id: 'taxes',    name: 'Property Taxes',       value: 1.2,   type: 'pct',    on: true,  note: '% of price/yr' },
  { id: 'assessments', name: 'Special Assessments',   value: 0,    type: 'flat',   on: false, note: 'annual $' },
  { id: 'insurance',name: 'Insurance',             value: 900,   type: 'per_unit', on: true, note: 'per unit/yr' },
  { id: 'mgmt',     name: 'Property Management',   value: 8,     type: 'pct_income', on: true, note: '% of income' },
  { id: 'repairs',  name: 'Repairs & Maintenance', value: 750,   type: 'per_unit', on: true, note: 'per unit/yr' },
  { id: 'utilities',name: 'Utilities',              value: 900,   type: 'per_unit', on: false, note: 'per unit/yr' },
  { id: 'gardener', name: 'Gardener / Landscaping', value: 100,  type: 'per_month', on: false, note: '$/month' },
  { id: 'pest',     name: 'Pest Control',           value: 75,   type: 'per_month', on: false, note: '$/month' },
  { id: 'reserves', name: 'Reserves',               value: 250,  type: 'per_unit', on: true,  note: 'per unit/yr' },
  { id: 'licenses', name: 'Licenses & Permits',     value: 1000, type: 'flat',     on: true,  note: 'annual $' },
];

let customExpenses = [];
let customId = 0;

// ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ
function toggleTheme() {
  const root = document.documentElement;
  const btn = document.getElementById('theme-btn');
  const isLight = root.getAttribute('data-theme') === 'light';
  if (isLight) {
    root.removeAttribute('data-theme');
    document.body.style.background = '#0a0c10';
    btn.textContent = 'üåô';
    localStorage.setItem('pb_theme', 'dark');
  } else {
    root.setAttribute('data-theme', 'light');
    document.body.style.background = '#f0f2f7';
    btn.textContent = '‚òÄÔ∏è';
    localStorage.setItem('pb_theme', 'light');
  }
}

// Load saved theme on start
(function() {
  const saved = localStorage.getItem('pb_theme');
  if (saved === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.body.style.background = '#f0f2f7';
    // btn not rendered yet, will be set in init
  }
})();

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function init() {
  addUnit();
  addUnit();
  renderDefaultExpenses();
  renderDebtToggle();
  calculate();
  // Set correct theme icon
  const saved = localStorage.getItem('pb_theme');
  const btn = document.getElementById('theme-btn');
  if (btn) btn.textContent = saved === 'light' ? '‚òÄÔ∏è' : 'üåô';
  // Set current month/year on analysis date
  const adEl = document.getElementById('analysis-date');
  if (adEl && !adEl.value) {
    const now = new Date();
    adEl.value = now.toISOString().slice(0, 7);
  }
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
let activeTab = 'income';

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['income','expenses','debt','results'][i] === tab);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  if (tab === 'results') calculate();
  updateNextBtn();
}

function updateNextBtn() {
  const btn = document.getElementById('next-btn');
  if (!btn) return;
  const tabOrder = ['income','expenses','debt','comps','results'];
  const idx = tabOrder.indexOf(activeTab);
  if (activeTab === 'debt') {
    btn.textContent = '‚Üí Comps';
  } else if (activeTab === 'comps') {
    btn.textContent = '‚Üí Results';
  } else if (activeTab === 'results') {
    btn.textContent = '‚Üê Back';
  } else {
    btn.textContent = '‚Üí Next';
  }
}

function goNext() {
  const tabOrder = ['income','expenses','debt','comps','results'];
  const idx = tabOrder.indexOf(activeTab);
  if (activeTab === 'results') {
    switchTab('income');
  } else {
    switchTab(tabOrder[idx + 1]);
  }
}

// ‚îÄ‚îÄ UNITS ‚îÄ‚îÄ
function addUnit() {
  const id = ++unitId;
  units.push({ id, type: '', rent: '', rent2: '', rent3: '' });
  renderUnits();
  calculate();
}

function removeUnit(id) {
  units = units.filter(u => u.id !== id);
  renderUnits();
  calculate();
}

function renderUnits() {
  const list = document.getElementById('units-list');
  if (units.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px;">No units added yet</div>';
    document.getElementById('unit-count-badge').textContent = '0 units';
    return;
  }
  const applyAll = document.getElementById('apply-all-yr2')?.checked;
  const globalPct = parseFloat(document.getElementById('global-yr2-pct')?.value) || 5;
  list.innerHTML = units.map((u, i) => {
    const idx = units.indexOf(u);
    const applyYr3 = document.getElementById('apply-all-yr3')?.checked;
    const yr2val = applyAll && u.rent ? Math.round(parseFloat(u.rent) * (1 + globalPct/100)) : (u.rent2 || '');
    const yr2base = parseFloat(yr2val) || parseFloat(u.rent) || 0;
    const yr3val = applyYr3 && yr2base ? Math.round(yr2base * (1 + globalPct/100)) : (u.rent3 || '');
    return `
    <div class="unit-row">
      <div class="unit-num">${i+1}</div>
      <select class="unit-select" onchange="units[${idx}].type=this.value;calculate()">
        <option value="" ${!u.type?'selected':''}>‚Äî Select ‚Äî</option>
        <option value="Studio" ${u.type==="Studio"?"selected":""}>Studio</option>
        <option value="1 Bed / 1 Bath" ${u.type==="1 Bed / 1 Bath"?"selected":""}>1 Bed / 1 Bath</option>
        <option value="2 Bed / 1 Bath" ${u.type==="2 Bed / 1 Bath"?"selected":""}>2 Bed / 1 Bath</option>
        <option value="2 Bed / 2 Bath" ${u.type==="2 Bed / 2 Bath"?"selected":""}>2 Bed / 2 Bath</option>
        <option value="3 Bed / 1 Bath" ${u.type==="3 Bed / 1 Bath"?"selected":""}>3 Bed / 1 Bath</option>
        <option value="3 Bed / 2 Bath" ${u.type==="3 Bed / 2 Bath"?"selected":""}>3 Bed / 2 Bath</option>
        <option value="3 Bed / 3 Bath" ${u.type==="3 Bed / 3 Bath"?"selected":""}>3 Bed / 3 Bath</option>
        <option value="4 Bed / 2 Bath" ${u.type==="4 Bed / 2 Bath"?"selected":""}>4 Bed / 2 Bath</option>
        <option value="4 Bed / 3 Bath" ${u.type==="4 Bed / 3 Bath"?"selected":""}>4 Bed / 3 Bath</option>
        <option value="Commercial" ${u.type==="Commercial"?"selected":""}>Commercial</option>
        <option value="Retail" ${u.type==="Retail"?"selected":""}>Retail</option>
        <option value="Office" ${u.type==="Office"?"selected":""}>Office</option>
      </select>
      <div style="position:relative;display:flex;align-items:center;">
        <span style="position:absolute;left:6px;font-family:var(--mono);font-size:11px;color:var(--text3);">$</span>
        <input class="unit-input" type="number" placeholder="1500" value="${u.rent}"
          style="padding-left:16px;height:34px;font-size:11px;"
          oninput="units[${idx}].rent=this.value;if(document.getElementById('apply-all-yr2').checked){applyAllYr2();}else{calculate();}" />
      </div>
      <div style="position:relative;display:flex;align-items:center;">
        <span style="position:absolute;left:4px;font-family:var(--mono);font-size:10px;color:rgba(56,217,169,0.5);z-index:1;">$</span>
        <input class="yr2-input" type="number" placeholder="‚Äî" value="${yr2val}"
          style="padding-left:14px;font-size:11px;"
          ${applyAll ? 'disabled' : ''}
          oninput="units[${idx}].rent2=this.value;calculate()" />
      </div>
      <div style="position:relative;display:flex;align-items:center;">
        <span style="position:absolute;left:4px;font-family:var(--mono);font-size:10px;color:rgba(247,201,72,0.5);z-index:1;">$</span>
        <input class="yr3-input" type="number" placeholder="‚Äî" value="${yr3val}"
          ${applyYr3 ? 'disabled' : ''}
          oninput="units[${idx}].rent3=this.value;calculate()" />
      </div>
      <button class="unit-remove" onclick="removeUnit(${u.id})">√ó</button>
    </div>
  `}).join('');
  document.getElementById('unit-count-badge').textContent = `${units.length} unit${units.length !== 1 ? 's' : ''}`;

  renderUnitTotals();
}

function renderUnitTotals() {
  const totalsEl = document.getElementById('units-totals');
  if (!totalsEl) return;
  if (units.length === 0) { totalsEl.innerHTML = ''; return; }
  const applyAll = document.getElementById('apply-all-yr2')?.checked;
  const applyYr3 = document.getElementById('apply-all-yr3')?.checked;
  const globalPct = parseFloat(document.getElementById('global-yr2-pct')?.value) || 5;
  const totalRent = units.reduce((s, u) => s + (parseFloat(u.rent) || 0), 0);
  const totalRent2 = units.reduce((s, u) => {
    const yr2 = applyAll && u.rent ? Math.round(parseFloat(u.rent) * (1 + globalPct/100)) : (parseFloat(u.rent2) || 0);
    return s + yr2;
  }, 0);
  const totalRent3 = units.reduce((s, u) => {
    const yr2base = applyAll && u.rent ? Math.round(parseFloat(u.rent) * (1 + globalPct/100)) : (parseFloat(u.rent2) || parseFloat(u.rent) || 0);
    const yr3 = applyYr3 && yr2base ? Math.round(yr2base * (1 + globalPct/100)) : (parseFloat(u.rent3) || 0);
    return s + yr3;
  }, 0);
  totalsEl.innerHTML = `
    <div class="units-totals-row">
      <span style="color:var(--text3);">#</span>
      <span style="color:var(--text3);">TOTAL</span>
      <span style="color:var(--text);">$${totalRent.toLocaleString()}<span style="font-size:9px;color:var(--text3);">/mo</span></span>
      <span style="color:var(--accent2);">${totalRent2 ? '$'+totalRent2.toLocaleString() : '‚Äî'}</span>
      <span style="color:var(--accent3);">${totalRent3 ? '$'+totalRent3.toLocaleString() : '‚Äî'}</span>
      <span></span>
    </div>
    <div style="padding:6px 12px 8px;display:grid;grid-template-columns:24px 72px 82px 72px 72px 22px;gap:5px;background:var(--surface2);" class="units-annual-row">
      <span></span>
      <span style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:0.06em;text-transform:uppercase;">ANNUAL</span>
      <span style="font-family:var(--mono);font-size:10px;color:var(--text3);">$${(totalRent*12).toLocaleString()}</span>
      <span style="font-family:var(--mono);font-size:10px;color:rgba(56,217,169,0.6);">${totalRent2 ? '$'+(totalRent2*12).toLocaleString() : ''}</span>
      <span style="font-family:var(--mono);font-size:10px;color:rgba(247,201,72,0.6);">${totalRent3 ? '$'+(totalRent3*12).toLocaleString() : ''}</span>
      <span></span>
    </div>`;
}

// ‚îÄ‚îÄ YEAR 2 APPLY ALL ‚îÄ‚îÄ
function applyAllYr2() {
  const applyYr2 = document.getElementById('apply-all-yr2')?.checked;
  const applyYr3 = document.getElementById('apply-all-yr3')?.checked;
  const globalPct = parseFloat(document.getElementById('global-yr2-pct')?.value) || 5;
  const mult = 1 + globalPct / 100;
  units.forEach(u => {
    const base = parseFloat(u.rent) || 0;
    if (applyYr2 && base) u.rent2 = Math.round(base * mult);
    const yr2base = parseFloat(u.rent2) || base;
    if (applyYr3 && yr2base) u.rent3 = Math.round(yr2base * mult);
  });
  // Update Yr 3 header label
  const yr3label = document.getElementById('yr3-header-label');
  if (yr3label) yr3label.textContent = applyYr3 ? 'Yr 3' : 'YR 3 PRO FORMA';
  renderUnits();
  calculate();
}

// ‚îÄ‚îÄ DEFAULT EXPENSES ‚îÄ‚îÄ
function renderDefaultExpenses() {
  const list = document.getElementById('default-expenses-list');
  list.innerHTML = defaultExpenses.map((e, i) => `
    <div class="expense-row">
      <div class="expense-toggle" onclick="toggleDefaultExpense(${i})">
        <div class="toggle ${e.on ? 'on' : ''}" id="toggle-${e.id}"></div>
        <span class="expense-name ${e.on ? '' : 'off'}" id="ename-${e.id}">${e.name}</span>
      </div>
      <input class="expense-input" type="number" value="${e.value}"
        step="${e.id === 'taxes' ? '0.01' : 'any'}"
        oninput="defaultExpenses[${i}].value=parseFloat(this.value)||0;calculate()"
        onblur="if('${e.id}'==='taxes'){const v=parseFloat(this.value);if(!isNaN(v)){this.value=v.toFixed(2);defaultExpenses[${i}].value=parseFloat(this.value);}}"
        ${e.on ? '' : 'disabled style="opacity:0.3"'} />
      <span style="font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap;">${e.note}</span>
      <div style="width:8px;"></div>
    </div>
  `).join('');
}

function toggleDefaultExpense(i) {
  defaultExpenses[i].on = !defaultExpenses[i].on;
  renderDefaultExpenses();
  calculate();
}

// ‚îÄ‚îÄ CUSTOM EXPENSES ‚îÄ‚îÄ
function addCustomExpense() {
  customExpenses.push({ id: ++customId, name: '', value: 0, type: 'flat' });
  renderCustomExpenses();
}

function removeCustomExpense(id) {
  customExpenses = customExpenses.filter(e => e.id !== id);
  renderCustomExpenses();
  calculate();
}

function renderCustomExpenses() {
  const list = document.getElementById('custom-expenses-list');
  document.getElementById('custom-count').textContent = `${customExpenses.length} added`;
  if (customExpenses.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:12px;font-family:var(--mono);">No custom expenses yet</div>';
    return;
  }
  list.innerHTML = customExpenses.map((e, i) => `
    <div class="expense-row">
      <input class="expense-input" placeholder="Expense name" value="${e.name}"
        oninput="customExpenses[${i}].name=this.value" style="min-width:0;" />
      <div style="position:relative;display:flex;align-items:center;">
        <span style="position:absolute;left:8px;font-family:var(--mono);font-size:12px;color:var(--text3);">$</span>
        <input class="expense-input" type="number" placeholder="0" value="${e.value||''}"
          style="padding-left:20px;"
          oninput="customExpenses[${i}].value=parseFloat(this.value)||0;calculate()" />
      </div>
      <span style="font-family:var(--mono);font-size:10px;color:var(--text3);">annual</span>
      <button class="expense-remove" onclick="removeCustomExpense(${e.id})">√ó</button>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ DEBT ‚îÄ‚îÄ
function toggleDebt() {
  debtEnabled = !debtEnabled;
  renderDebtToggle();
  calculate();
}

function renderDebtToggle() {
  const t = document.getElementById('debt-toggle');
  if (t) t.className = `toggle ${debtEnabled ? 'on' : ''}`;
}

function calcMonthlyPayment(principal, annualRate, years) {
  if (!principal || !annualRate || !years) return 0;
  const r = annualRate / 100 / 12;
  const n = years * 12;
  if (r === 0) return principal / n;
  return principal * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
}

// ‚îÄ‚îÄ PRICE INPUT FORMATTER ‚îÄ‚îÄ
function formatPriceInput(el) {
  const raw = el.value.replace(/[^0-9]/g, '');
  const formatted = raw ? parseInt(raw, 10).toLocaleString() : '';
  el.value = formatted;
  calculate();
}

// ‚îÄ‚îÄ MAIN CALCULATE ‚îÄ‚îÄ
function calculate() {
  const price = parseFloat(document.getElementById('prop-price').value.replace(/,/g, '')) || 0;
  const bldgSF = parseFloat(document.getElementById('prop-bldg-sf').value) || 0;
  const landSF = parseFloat(document.getElementById('prop-land-sf').value) || 0;
  const otherIncome = (parseFloat(document.getElementById('laundry-income').value) || 0) + (parseFloat(document.getElementById('parking-income').value) || 0);
  const vacancyPct = parseFloat(document.getElementById('vacancy-rate').value) || 5;

  // Monthly rent ‚Äî current
  const monthlyRent = units.reduce((s, u) => s + (parseFloat(u.rent) || 0), 0);
  const grossMonthly = monthlyRent + otherIncome;
  const grossAnnual = grossMonthly * 12;
  const vacancyLoss = grossAnnual * (vacancyPct / 100);
  const effectiveGross = grossAnnual - vacancyLoss;

  // Monthly rent ‚Äî year 2
  const hasYr2 = units.some(u => u.rent2 && parseFloat(u.rent2) > 0);
  const hasYr3 = units.some(u => u.rent3 && parseFloat(u.rent3) > 0);
  const monthlyRentYr3 = hasYr3 ? units.reduce((s, u) => s + (parseFloat(u.rent3) || parseFloat(u.rent2) || parseFloat(u.rent) || 0), 0) : 0;
  const monthlyRentYr2 = hasYr2 ? units.reduce((s, u) => s + (parseFloat(u.rent2) || parseFloat(u.rent) || 0), 0) : 0;
  const grossMonthlyYr2 = monthlyRentYr2 + otherIncome;
  const grossAnnualYr2 = grossMonthlyYr2 * 12;
  const vacancyLossYr2 = grossAnnualYr2 * (vacancyPct / 100);
  const effectiveGrossYr2 = grossAnnualYr2 - vacancyLossYr2;

  // Expenses
  const numUnits = units.length || 1;
  let totalExpenses = 0;

  defaultExpenses.forEach(e => {
    if (!e.on) return;
    let amt = 0;
    if (e.type === 'pct') amt = price * (e.value / 100);
    else if (e.type === 'per_unit') amt = e.value * numUnits;
    else if (e.type === 'pct_income') amt = effectiveGross * (e.value / 100);
    else if (e.type === 'per_month') amt = e.value * 12;
    else if (e.type === 'flat') amt = e.value;
    totalExpenses += amt;
  });

  customExpenses.forEach(e => { totalExpenses += (e.value || 0); });

  const noi = effectiveGross - totalExpenses;
  const grossMonthlyYr3 = monthlyRentYr3 + otherIncome;
  const grossAnnualYr3 = grossMonthlyYr3 * 12;
  const vacancyLossYr3 = grossAnnualYr3 * (vacancyPct / 100);
  const effectiveGrossYr3 = grossAnnualYr3 - vacancyLossYr3;
  const noiYr2 = hasYr2 ? effectiveGrossYr2 - totalExpenses : null;
  const noiYr3 = hasYr3 ? effectiveGrossYr3 - totalExpenses : null;
  const capRate = price > 0 ? (noi / price) * 100 : 0;
  const capRateYr2 = (hasYr2 && price > 0) ? (noiYr2 / price) * 100 : null;
  const capRateYr3 = (hasYr3 && price > 0) ? (noiYr3 / price) * 100 : null;
  const grm = grossAnnual > 0 ? price / grossAnnual : 0;
  const expenseRatio = effectiveGross > 0 ? (totalExpenses / effectiveGross) * 100 : 0;

  // Debt
  const downPct = parseFloat(document.getElementById('down-pct').value) || 25;
  const intRate = parseFloat(document.getElementById('int-rate').value) || 6.5;
  const amortYears = parseFloat(document.getElementById('amort-years').value) || 30;
  const loanAmt = price * (1 - downPct / 100);
  const monthlyPayment = calcMonthlyPayment(loanAmt, intRate, amortYears);
  const annualDebt = monthlyPayment * 12;
  const cashFlow = debtEnabled ? noi - annualDebt : null;
  const cashFlowYr2 = (hasYr2 && debtEnabled) ? noiYr2 - annualDebt : null;
  const cashFlowYr3 = (hasYr3 && debtEnabled) ? noiYr3 - annualDebt : null;
  const dcr = annualDebt > 0 ? noi / annualDebt : null;
  const downPayment = price * (downPct / 100);
  const coc = (debtEnabled && downPayment > 0) ? (cashFlow / downPayment) * 100 : null;

  // Update down payment amount and loan balance displays
  const downAmtDisplay = document.getElementById('down-amt-display');
  const loanBalDisplay = document.getElementById('loan-bal-display');
  if (downAmtDisplay) downAmtDisplay.textContent = price > 0 ? '$' + fmt(downPayment) : '‚Äî';
  if (loanBalDisplay) loanBalDisplay.textContent = price > 0 ? '$' + fmt(loanAmt) : '‚Äî';

  // Update monthly payment display
  const mpDisplay = document.getElementById('monthly-payment-display');
  if (mpDisplay) mpDisplay.textContent = price > 0 ? '$' + fmt(monthlyPayment) : '‚Äî';

  // Update annual debt service display
  const adDisplay = document.getElementById('annual-debt-display');
  if (adDisplay) adDisplay.textContent = price > 0 ? '$' + fmt(annualDebt) + '/yr' : '‚Äî';

  // Update DSCR display on debt tab
  const dscrDisplay = document.getElementById('dscr-display');
  const dscrBadge = document.getElementById('dscr-badge');
  if (dscrDisplay) {
    const dscrVal = (annualDebt > 0 && noi > 0) ? noi / annualDebt : null;
    if (dscrVal) {
      dscrDisplay.textContent = dscrVal.toFixed(2) + 'x';
      if (dscrVal >= 1.25) {
        dscrDisplay.style.color = 'var(--accent2)';
        dscrBadge.style.display = 'block';
        dscrBadge.style.background = 'rgba(56,217,169,0.15)';
        dscrBadge.style.color = 'var(--accent2)';
        dscrBadge.textContent = '‚úì Approved';
      } else if (dscrVal >= 1.0) {
        dscrDisplay.style.color = 'var(--accent3)';
        dscrBadge.style.display = 'block';
        dscrBadge.style.background = 'rgba(247,201,72,0.15)';
        dscrBadge.style.color = 'var(--accent3)';
        dscrBadge.textContent = '‚ö† Tight';
      } else {
        dscrDisplay.style.color = 'var(--danger)';
        dscrBadge.style.display = 'block';
        dscrBadge.style.background = 'rgba(247,110,110,0.15)';
        dscrBadge.style.color = 'var(--danger)';
        dscrBadge.textContent = '‚úó Below 1.0';
      }
    } else {
      dscrDisplay.textContent = '‚Äî';
      dscrDisplay.style.color = 'var(--text2)';
      if (dscrBadge) dscrBadge.style.display = 'none';
    }
  }

  // Render results
  renderUnitTotals();
  renderResults({
    price, grossMonthly, grossAnnual, vacancyLoss, effectiveGross,
    totalExpenses, noi, capRate, grm, expenseRatio,
    annualDebt, cashFlow, dcr, coc, downPayment, loanAmt,
    monthlyPayment, numUnits, bldgSF, landSF,
    hasYr2, grossMonthlyYr2, grossAnnualYr2, vacancyLossYr2, effectiveGrossYr2, noiYr2, capRateYr2, cashFlowYr2,
    hasYr3, grossMonthlyYr3, grossAnnualYr3, effectiveGrossYr3, noiYr3, capRateYr3, cashFlowYr3
  });
}

function fmt(n) {
  if (!n && n !== 0) return '‚Äî';
  return Math.abs(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
}
function fmtSigned(n) {
  if (n === null || n === undefined) return '‚Äî';
  const sign = n < 0 ? '-' : '+';
  return sign + '$' + fmt(n);
}
function fmtPct(n) {
  if (!n && n !== 0) return '‚Äî';
  return n.toFixed(2) + '%';
}
function fmtX(n) {
  if (!n && n !== 0) return '‚Äî';
  return n.toFixed(2) + 'x';
}

function renderResults(d) {
  const el = document.getElementById('results-content');

  if (!d.grossAnnual) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üè¢</div><div class="empty-title">No data yet</div>Add units on the Income tab and set a price on the Debt tab</div>`;
    return;
  }

  const addr = document.getElementById('prop-address').value;
  const city = document.getElementById('prop-city').value;
  const zip = document.getElementById('prop-zip')?.value || '';
  const state = document.getElementById('prop-state')?.value || '';
  const propName = addr ? `${addr}${city ? ', ' + city : ''}${state ? ', ' + state.toUpperCase() : ''}${zip ? ' ' + zip : ''}` : 'Property Analysis';

  el.innerHTML = `
    <div style="margin-bottom:16px;">
      <div style="font-family:var(--display);font-weight:800;font-size:18px;letter-spacing:-0.5px;color:var(--text);margin-bottom:2px;">${propName}</div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--text3);">${d.numUnits} unit${d.numUnits !== 1 ? 's' : ''} ¬∑ asking ${d.price ? '$' + fmt(d.price) : 'N/A'}</div>
    </div>

    <div class="results-grid">
      <div class="result-card blue">
        <div class="result-label">Cap Rate</div>
        <div class="result-value">${d.capRate ? fmtPct(d.capRate) : '‚Äî'}</div>
        <div class="result-sub">NOI / Price</div>
      </div>
      <div class="result-card green">
        <div class="result-label">NOI</div>
        <div class="result-value">${d.noi ? '$' + fmt(d.noi) : '‚Äî'}</div>
        <div class="result-sub">Annual</div>
      </div>
      <div class="result-card gold">
        <div class="result-label">GRM</div>
        <div class="result-value">${d.grm ? fmtX(d.grm) : '‚Äî'}</div>
        <div class="result-sub">Price / Gross Rent</div>
      </div>
      <div class="result-card ${debtEnabled ? (d.cashFlow >= 0 ? 'green' : 'red') : 'blue'}">
        <div class="result-label">Cash Flow</div>
        <div class="result-value">${debtEnabled ? fmtSigned(d.cashFlow) : 'N/A'}</div>
        <div class="result-sub">${debtEnabled ? 'Annual after debt' : 'Enable debt tab'}</div>
      </div>
      ${debtEnabled && d.dcr ? `
      <div class="result-card ${d.dcr >= 1.25 ? 'green' : 'red'}">
        <div class="result-label">Debt Coverage</div>
        <div class="result-value">${fmtX(d.dcr)}</div>
        <div class="result-sub">${d.dcr >= 1.25 ? '‚úì Lender approved' : '‚úó Below 1.25x'}</div>
      </div>
      <div class="result-card blue">
        <div class="result-label">Cash-on-Cash</div>
        <div class="result-value">${d.coc !== null ? fmtPct(d.coc) : '‚Äî'}</div>
        <div class="result-sub">Return on equity</div>
      </div>` : ''}
      <div class="result-card gold">
        <div class="result-label">Price / Unit</div>
        <div class="result-value">${d.price && d.numUnits ? '$' + fmt(d.price / d.numUnits) : '‚Äî'}</div>
        <div class="result-sub">Per door</div>
      </div>
      <div class="result-card blue">
        <div class="result-label">Price / Bldg SF</div>
        <div class="result-value">${d.bldgSF ? '$' + (d.price / d.bldgSF).toFixed(0) : '‚Äî'}</div>
        <div class="result-sub">${d.bldgSF ? d.bldgSF.toLocaleString() + ' sf' : 'Enter bldg sf'}</div>
      </div>
      <div class="result-card green">
        <div class="result-label">Price / Land SF</div>
        <div class="result-value">${d.landSF ? '$' + (d.price / d.landSF).toFixed(0) : '‚Äî'}</div>
        <div class="result-sub">${d.landSF ? d.landSF.toLocaleString() + ' sf' : 'Enter land sf'}</div>
      </div>
    </div>

    ${(d.hasYr2 || d.hasYr3) ? `
    <div style="margin-bottom:16px;">
      <div style="font-family:var(--display);font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px;padding:0 2px;">Rent Projection</div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:8px 10px;font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;border-right:1px solid var(--border);">Metric</div>
          <div style="padding:8px 10px;font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;border-right:1px solid var(--border);">Now</div>
          <div style="padding:8px 10px;font-family:var(--mono);font-size:9px;color:var(--accent2);text-transform:uppercase;letter-spacing:0.06em;border-right:1px solid var(--border);">Yr 2</div>
          <div style="padding:8px 10px;font-family:var(--mono);font-size:9px;color:var(--accent3);text-transform:uppercase;letter-spacing:0.06em;">Yr 3</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:9px 10px;font-size:11px;color:var(--text2);border-right:1px solid var(--border);">Rent/mo</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--text);border-right:1px solid var(--border);">$${fmt(d.grossMonthly)}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent2);border-right:1px solid var(--border);">${d.hasYr2 ? '$'+fmt(d.grossMonthlyYr2) : '‚Äî'}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent3);">${d.hasYr3 ? '$'+fmt(d.grossMonthlyYr3) : '‚Äî'}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:9px 10px;font-size:11px;color:var(--text2);border-right:1px solid var(--border);">Eff. Gross</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--text);border-right:1px solid var(--border);">$${fmt(d.effectiveGross)}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent2);border-right:1px solid var(--border);">${d.hasYr2 ? '$'+fmt(d.effectiveGrossYr2) : '‚Äî'}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent3);">${d.hasYr3 ? '$'+fmt(d.effectiveGrossYr3) : '‚Äî'}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:9px 10px;font-size:11px;color:var(--text2);border-right:1px solid var(--border);">NOI</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--text);border-right:1px solid var(--border);">$${fmt(d.noi)}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent2);border-right:1px solid var(--border);">${d.hasYr2 ? '$'+fmt(d.noiYr2) : '‚Äî'}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent3);">${d.hasYr3 ? '$'+fmt(d.noiYr3) : '‚Äî'}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;${(d.cashFlowYr2 !== null || d.cashFlowYr3 !== null) ? 'border-bottom:1px solid var(--border);' : ''}">
          <div style="padding:9px 10px;font-size:11px;color:var(--text2);border-right:1px solid var(--border);">Cap Rate</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--text);border-right:1px solid var(--border);">${fmtPct(d.capRate)}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent2);border-right:1px solid var(--border);">${d.hasYr2 ? fmtPct(d.capRateYr2) : '‚Äî'}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent3);">${d.hasYr3 ? fmtPct(d.capRateYr3) : '‚Äî'}</div>
        </div>
        ${(d.cashFlowYr2 !== null || d.cashFlowYr3 !== null) ? `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;">
          <div style="padding:9px 10px;font-size:11px;color:var(--text2);border-right:1px solid var(--border);">Cash Flow</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--text);border-right:1px solid var(--border);">${fmtSigned(d.cashFlow)}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent2);border-right:1px solid var(--border);">${d.cashFlowYr2 !== null ? fmtSigned(d.cashFlowYr2) : '‚Äî'}</div>
          <div style="padding:9px 10px;font-family:var(--mono);font-size:11px;color:var(--accent3);">${d.cashFlowYr3 !== null ? fmtSigned(d.cashFlowYr3) : '‚Äî'}</div>
        </div>` : ''}
      </div>
    </div>` : ''}

    <div class="waterfall">
      <div class="wf-row" style="background:var(--surface2);">
        <div class="wf-label" style="font-family:var(--display);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;">Income & Expense Waterfall</div>
        <div></div>
      </div>
      <div class="wf-row">
        <div class="wf-label">Gross Scheduled Income</div>
        <div class="wf-value">$${fmt(d.grossAnnual)}/yr</div>
      </div>
      <div class="wf-row">
        <div class="wf-label indent">Less: Vacancy (${document.getElementById('vacancy-rate').value || 5}%)</div>
        <div class="wf-value neg">-$${fmt(d.vacancyLoss)}</div>
      </div>
      <div class="wf-row total">
        <div class="wf-label">Effective Gross Income</div>
        <div class="wf-value highlight">$${fmt(d.effectiveGross)}</div>
      </div>
      <div class="wf-row">
        <div class="wf-label indent">Less: Total Expenses (${d.expenseRatio.toFixed(0)}%)</div>
        <div class="wf-value neg">-$${fmt(d.totalExpenses)}</div>
      </div>
      <div class="wf-row total">
        <div class="wf-label">Net Operating Income</div>
        <div class="wf-value pos">$${fmt(d.noi)}</div>
      </div>
      ${debtEnabled ? `
      <div class="wf-row">
        <div class="wf-label indent">Less: Debt Service</div>
        <div class="wf-value neg">-$${fmt(d.annualDebt)}</div>
      </div>
      <div class="wf-row total">
        <div class="wf-label">Cash Flow Before Tax</div>
        <div class="wf-value ${d.cashFlow >= 0 ? 'pos' : 'neg'}">${fmtSigned(d.cashFlow)}</div>
      </div>` : ''}
    </div>

    ${d.price ? `
    <div class="section">
      <div class="section-header"><div class="section-title">Deal Metrics</div></div>
      <div class="wf-row"><div class="wf-label">Gross Monthly Income</div><div class="wf-value">$${fmt(d.grossMonthly)}/mo</div></div>
      <div class="wf-row"><div class="wf-label">Expense Ratio</div><div class="wf-value">${d.expenseRatio.toFixed(1)}%</div></div>
      ${debtEnabled ? `
      <div class="wf-row"><div class="wf-label">Down Payment</div><div class="wf-value">$${fmt(d.downPayment)}</div></div>
      <div class="wf-row"><div class="wf-label">Loan Amount</div><div class="wf-value">$${fmt(d.loanAmt)}</div></div>
      <div class="wf-row"><div class="wf-label">Monthly Payment</div><div class="wf-value">$${fmt(d.monthlyPayment)}/mo</div></div>
      ` : ''}
    </div>` : ''}
  `;
}

// ‚îÄ‚îÄ COPY SNAPSHOT ‚îÄ‚îÄ
// ‚îÄ‚îÄ EXPORT EXCEL ‚îÄ‚îÄ
function exportExcel() {
  const addr = document.getElementById('prop-address').value || 'Property';
  const city = document.getElementById('prop-city').value || '';
  const price = parseFloat(document.getElementById('prop-price').value.replace(/,/g, '')) || 0;
  const yr = document.getElementById('prop-year').value || '';
  const bldgSF = parseFloat(document.getElementById('prop-bldg-sf').value) || 0;
  const landSF = parseFloat(document.getElementById('prop-land-sf').value) || 0;
  const vacancy = parseFloat(document.getElementById('vacancy-rate').value) || 5;
  const laundry = parseFloat(document.getElementById('laundry-income').value) || 0;
  const parking = parseFloat(document.getElementById('parking-income').value) || 0;
  const downPct = parseFloat(document.getElementById('down-pct').value) || 25;
  const intRate = parseFloat(document.getElementById('int-rate').value) || 6.5;
  const amortYears = parseFloat(document.getElementById('amort-years').value) || 30;

  const monthlyRent = units.reduce((s,u) => s + (parseFloat(u.rent)||0), 0);
  const otherIncome = laundry + parking;
  const grossMonthly = monthlyRent + otherIncome;
  const grossAnnual = grossMonthly * 12;
  const vacancyLoss = grossAnnual * (vacancy/100);
  const effectiveGross = grossAnnual - vacancyLoss;

  const numUnits = units.length || 1;
  let totalExpenses = 0;
  defaultExpenses.forEach(e => {
    if (!e.on) return;
    let amt = 0;
    if (e.type === 'pct') amt = price * (e.value/100);
    else if (e.type === 'per_unit') amt = e.value * numUnits;
    else if (e.type === 'pct_income') amt = effectiveGross * (e.value/100);
    else if (e.type === 'per_month') amt = e.value * 12;
    else if (e.type === 'flat') amt = e.value;
    totalExpenses += amt;
  });
  customExpenses.forEach(e => { totalExpenses += (e.value||0); });
  const noi = effectiveGross - totalExpenses;
  const capRate = price > 0 ? (noi/price)*100 : 0;
  const grm = grossAnnual > 0 ? price/grossAnnual : 0;
  const loanAmt = price * (1 - downPct/100);
  const downPayment = price * (downPct/100);
  const r = intRate/100/12;
  const n = amortYears*12;
  const monthlyPayment = r > 0 ? loanAmt * r * Math.pow(1+r,n) / (Math.pow(1+r,n)-1) : loanAmt/n;
  const annualDebt = monthlyPayment * 12;
  const cashFlow = debtEnabled ? noi - annualDebt : null;
  const dcr = annualDebt > 0 ? noi/annualDebt : null;
  const coc = (debtEnabled && downPayment > 0) ? (cashFlow/downPayment)*100 : null;

  const wb = XLSX.utils.book_new();

  // ‚îÄ‚îÄ Sheet 1: Summary ‚îÄ‚îÄ
  const summaryData = [
    ['POCKETBROKER ‚Äî DEAL ANALYSIS', ''],
    ['Generated by @TheGoogleGrad', ''],
    ['', ''],
    ['PROPERTY INFO', ''],
    ['Address', addr + (city ? ', ' + city : '')],
    ['Asking Price', price],
    ['Year Built', yr],
    ['Units', numUnits],
    ['Building SF', bldgSF || '‚Äî'],
    ['Land SF', landSF || '‚Äî'],
    ['', ''],
    ['KEY METRICS', ''],
    ['Cap Rate', (capRate/100)],
    ['NOI', noi],
    ['GRM', grm],
    ['Price Per Unit', price/numUnits],
    bldgSF ? ['Price / Bldg SF', price/bldgSF] : null,
    landSF ? ['Price / Land SF', price/landSF] : null,
    ['', ''],
    ['INCOME', ''],
    ['Gross Monthly Rent', monthlyRent],
    ['Laundry Income', laundry],
    ['Parking Income', parking],
    ['Gross Annual Income', grossAnnual],
    ['Vacancy Loss (' + vacancy + '%)', -vacancyLoss],
    ['Effective Gross Income', effectiveGross],
    ['', ''],
    ['EXPENSES', ''],
    ['Total Annual Expenses', -totalExpenses],
    ['Expense Ratio', (totalExpenses/effectiveGross)],
    ['', ''],
    ['NET OPERATING INCOME', noi],
    ['', ''],
  ].filter(Boolean);

  if (debtEnabled) {
    summaryData.push(['DEBT', '']);
    summaryData.push(['Down Payment (' + downPct + '%)', downPayment]);
    summaryData.push(['Loan Amount', loanAmt]);
    summaryData.push(['Interest Rate', intRate/100]);
    summaryData.push(['Amortization', amortYears + ' years']);
    summaryData.push(['Monthly Payment', monthlyPayment]);
    summaryData.push(['Annual Debt Service', annualDebt]);
    summaryData.push(['Cash Flow', cashFlow]);
    summaryData.push(['DSCR', dcr]);
    summaryData.push(['Cash-on-Cash Return', coc/100]);
  }

  const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
  ws1['!cols'] = [{wch:28},{wch:18}];

  // Format currency and percent cells
  summaryData.forEach((row, i) => {
    if (!row || row[1] === '' || row[1] === '‚Äî' || typeof row[1] !== 'number') return;
    const cellRef = XLSX.utils.encode_cell({r:i, c:1});
    if (!ws1[cellRef]) return;
    const label = row[0].toLowerCase();
    if (label.includes('rate') || label.includes('ratio') || label.includes('dscr') || label.includes('grm')) {
      ws1[cellRef].z = label.includes('%') || label.includes('ratio') || label.includes('return') ? '0.00%' : '0.00x';
    } else {
      ws1[cellRef].z = '$#,##0';
    }
  });

  // ‚îÄ‚îÄ Sheet 2: Rent Roll ‚îÄ‚îÄ
  const rentRollData = [
    ['#', 'Unit Type', 'Current Rent/Mo', 'Year 2 Rent/Mo', 'Current Annual', 'Year 2 Annual'],
  ];
  units.forEach((u, i) => {
    const rent = parseFloat(u.rent) || 0;
    const rent2 = parseFloat(u.rent2) || 0;
    rentRollData.push([
      i+1,
      u.type || '‚Äî',
      rent,
      rent2 || '‚Äî',
      rent * 12,
      rent2 ? rent2 * 12 : '‚Äî'
    ]);
  });
  rentRollData.push(['', 'TOTAL', monthlyRent, '', monthlyRent*12, '']);

  const ws2 = XLSX.utils.aoa_to_sheet(rentRollData);
  ws2['!cols'] = [{wch:4},{wch:16},{wch:16},{wch:16},{wch:16},{wch:16}];

  XLSX.utils.book_append_sheet(wb, ws1, 'Deal Summary');
  XLSX.utils.book_append_sheet(wb, ws2, 'Rent Roll');

  const filename = (addr || 'deal').replace(/[^a-z0-9]/gi,'_') + '_PocketBroker.xlsx';
  XLSX.writeFile(wb, filename);
  showToast('‚úì Excel downloaded!');
}

// ‚îÄ‚îÄ EXPORT PDF ‚îÄ‚îÄ
function exportPDF() {
  const addr = document.getElementById('prop-address').value || 'Property';
  const city = document.getElementById('prop-city').value || '';
  const zip = document.getElementById('prop-zip')?.value || '';
  const state = document.getElementById('prop-state')?.value || '';
  const yr = document.getElementById('prop-year').value || '';
  const bldgSF = parseFloat(document.getElementById('prop-bldg-sf').value) || 0;
  const landSF = parseFloat(document.getElementById('prop-land-sf').value) || 0;
  const price = parseFloat(document.getElementById('prop-price').value.replace(/,/g,'')) || 0;
  const vacancy = parseFloat(document.getElementById('vacancy-rate').value) || 5;
  const laundry = parseFloat(document.getElementById('laundry-income').value) || 0;
  const parking = parseFloat(document.getElementById('parking-income').value) || 0;
  const downPct = parseFloat(document.getElementById('down-pct').value) || 25;
  const intRate = parseFloat(document.getElementById('int-rate').value) || 6.5;
  const amortYears = parseFloat(document.getElementById('amort-years').value) || 30;

  const numUnits = units.length || 1;
  const monthlyRent = units.reduce((s,u) => s+(parseFloat(u.rent)||0),0);
  const otherIncome = laundry + parking;
  const grossMonthly = monthlyRent + otherIncome;
  const grossAnnual = grossMonthly * 12;
  const vacancyLoss = grossAnnual * (vacancy/100);
  const effectiveGross = grossAnnual - vacancyLoss;

  let totalExpenses = 0;
  const expenseLines = [];
  defaultExpenses.forEach(e => {
    if (!e.on) return;
    let amt = 0;
    if (e.type==='pct') amt = price*(e.value/100);
    else if (e.type==='per_unit') amt = e.value*numUnits;
    else if (e.type==='pct_income') amt = effectiveGross*(e.value/100);
    else if (e.type==='per_month') amt = e.value*12;
    else if (e.type==='flat') amt = e.value;
    totalExpenses += amt;
    expenseLines.push({name: e.name, value: amt});
  });
  customExpenses.forEach(e => {
    totalExpenses += (e.value||0);
    expenseLines.push({name: e.name, value: e.value||0});
  });

  const noi = effectiveGross - totalExpenses;
  const capRate = price > 0 ? (noi/price)*100 : 0;
  const grm = grossAnnual > 0 ? price/grossAnnual : 0;
  const loanAmt = price*(1-downPct/100);
  const downPayment = price*(downPct/100);
  const r = intRate/100/12;
  const n = amortYears*12;
  const monthlyPayment = r>0 ? loanAmt*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1) : loanAmt/n;
  const annualDebt = monthlyPayment*12;
  const cashFlow = debtEnabled ? noi-annualDebt : null;
  const dcr = (debtEnabled && annualDebt>0) ? noi/annualDebt : null;
  const coc = (debtEnabled && downPayment>0) ? (cashFlow/downPayment)*100 : null;
  const expRatio = effectiveGross > 0 ? (totalExpenses/effectiveGross)*100 : 0;

  const f = n => n.toLocaleString('en-US',{maximumFractionDigits:0});
  const fp = n => n != null ? n.toFixed(2)+'%' : '‚Äî';
  const fd = n => n != null ? '$'+f(n) : '‚Äî';
  const propName = [addr, city, state.toUpperCase(), zip].filter(Boolean).join(', ');
  const today = new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  const rentRows = units.map((u,i) => `
    <tr>
      <td>${i+1}</td>
      <td>${u.type||'‚Äî'}</td>
      <td>${fd(parseFloat(u.rent)||0)}</td>
      <td style="color:#38d9a9;">${u.rent2 ? fd(parseFloat(u.rent2)) : '‚Äî'}</td>
      <td>${fd((parseFloat(u.rent)||0)*12)}</td>
    </tr>`).join('');

  const expenseRows = expenseLines.map(e => `
    <tr><td>${e.name}</td><td>${fd(e.value)}</td></tr>`).join('');

  const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PocketBroker ‚Äî ${propName}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600&family=Syne:wght@700;800&display=swap');
  * { margin:0;padding:0;box-sizing:border-box; }
  body { background:#0a0c10;color:#e8ecf4;font-family:'DM Sans',sans-serif;padding:32px;min-height:100vh; }
  .header { display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;padding-bottom:20px;border-bottom:1px solid #252b38; }
  .logo { font-family:'Syne',sans-serif;font-weight:800;font-size:22px;letter-spacing:-0.5px; }
  .logo span { color:#4f8ef7; }
  .prop-name { font-family:'Syne',sans-serif;font-weight:800;font-size:20px;margin-bottom:4px; }
  .prop-sub { font-family:'DM Mono',monospace;font-size:11px;color:#8892a4; }
  .date { font-family:'DM Mono',monospace;font-size:10px;color:#4f5a6e;text-align:right; }
  .metrics-grid { display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px; }
  .metric-card { background:#12151c;border:1px solid #252b38;border-radius:10px;padding:14px; }
  .metric-card.blue { border-top:2px solid #4f8ef7; }
  .metric-card.green { border-top:2px solid #38d9a9; }
  .metric-card.gold { border-top:2px solid #f7c948; }
  .metric-card.red { border-top:2px solid #f76e6e; }
  .metric-label { font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:#4f5a6e;margin-bottom:6px; }
  .metric-value { font-family:'Syne',sans-serif;font-weight:800;font-size:20px;letter-spacing:-0.5px;line-height:1; }
  .metric-value.blue { color:#4f8ef7; }
  .metric-value.green { color:#38d9a9; }
  .metric-value.gold { color:#f7c948; }
  .metric-value.red { color:#f76e6e; }
  .metric-sub { font-family:'DM Mono',monospace;font-size:9px;color:#4f5a6e;margin-top:4px; }
  .section-title { font-family:'Syne',sans-serif;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.1em;color:#8892a4;margin-bottom:10px; }
  .two-col { display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px; }
  table { width:100%;border-collapse:collapse;background:#12151c;border-radius:10px;overflow:hidden;border:1px solid #252b38; }
  th { font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.08em;text-transform:uppercase;color:#4f5a6e;padding:10px 12px;text-align:left;background:#1a1f2a;border-bottom:1px solid #252b38; }
  td { font-family:'DM Mono',monospace;font-size:11px;color:#e8ecf4;padding:8px 12px;border-bottom:1px solid #1a1f2a; }
  tr:last-child td { border-bottom:none; }
  .wf-table td:last-child { text-align:right;color:#8892a4; }
  .wf-total td { background:#1a1f2a;font-weight:600; }
  .wf-total td:last-child { color:#38d9a9; }
  .footer { margin-top:32px;padding-top:16px;border-top:1px solid #252b38;display:flex;justify-content:space-between;align-items:center; }
  .footer-logo { font-family:'Syne',sans-serif;font-weight:800;font-size:14px; }
  .footer-logo span { color:#4f8ef7; }
  .footer-note { font-family:'DM Mono',monospace;font-size:9px;color:#4f5a6e; }
  @media print {
    body { background:#0a0c10 !important;-webkit-print-color-adjust:exact;print-color-adjust:exact; }
    @page { margin:0.5cm;background:#0a0c10; }
  }
</style>
</head>
<body>
  <div class="header">
    <div>
      <div class="logo">Pocket<span>Broker</span></div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:#4f5a6e;letter-spacing:0.08em;margin-top:2px;">DEAL ANALYSIS REPORT</div>
    </div>
    <div class="date">
      <div style="font-size:13px;font-weight:600;color:#e8ecf4;font-family:'Syne',sans-serif;">${propName||'Property Analysis'}</div>
      <div style="margin-top:4px;">${yr ? 'Built '+yr+' ¬∑ ' : ''}${numUnits} units${bldgSF?' ¬∑ '+f(bldgSF)+' SF':''}</div>
      <div style="margin-top:2px;">Asking: ${price?'$'+f(price):'‚Äî'} &nbsp;¬∑&nbsp; ${today}</div>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="section-title">Key Metrics</div>
  <div class="metrics-grid" style="margin-bottom:24px;">
    <div class="metric-card blue">
      <div class="metric-label">Cap Rate</div>
      <div class="metric-value blue">${fp(capRate)}</div>
      <div class="metric-sub">NOI / Price</div>
    </div>
    <div class="metric-card green">
      <div class="metric-label">NOI</div>
      <div class="metric-value green">${fd(noi)}</div>
      <div class="metric-sub">Annual</div>
    </div>
    <div class="metric-card gold">
      <div class="metric-label">GRM</div>
      <div class="metric-value gold">${grm?grm.toFixed(2)+'x':'‚Äî'}</div>
      <div class="metric-sub">Price / Gross Rent</div>
    </div>
    <div class="metric-card ${cashFlow!=null?(cashFlow>=0?'green':'red'):'blue'}">
      <div class="metric-label">Cash Flow</div>
      <div class="metric-value ${cashFlow!=null?(cashFlow>=0?'green':'red'):'blue'}">${cashFlow!=null?fd(cashFlow):'N/A'}</div>
      <div class="metric-sub">Annual after debt</div>
    </div>
    ${debtEnabled?`
    <div class="metric-card gold">
      <div class="metric-label">DSCR</div>
      <div class="metric-value ${dcr>=1.25?'green':dcr>=1?'gold':'red'}">${dcr?dcr.toFixed(2)+'x':'‚Äî'}</div>
      <div class="metric-sub">${dcr>=1.25?'‚úì Approved':dcr>=1?'‚ö† Tight':'‚úó Below 1.0'}</div>
    </div>
    <div class="metric-card blue">
      <div class="metric-label">Cash-on-Cash</div>
      <div class="metric-value blue">${coc!=null?coc.toFixed(2)+'%':'‚Äî'}</div>
      <div class="metric-sub">Return on equity</div>
    </div>`:''}
    <div class="metric-card gold">
      <div class="metric-label">Price / Unit</div>
      <div class="metric-value gold">${price?fd(price/numUnits):'‚Äî'}</div>
      <div class="metric-sub">Per door</div>
    </div>
    ${bldgSF?`<div class="metric-card blue">
      <div class="metric-label">Price / Bldg SF</div>
      <div class="metric-value blue">${price?'$'+f(price/bldgSF):'‚Äî'}</div>
      <div class="metric-sub">${f(bldgSF)} SF</div>
    </div>`:''}
  </div>

  <div class="two-col">
    <!-- Waterfall -->
    <div>
      <div class="section-title">Income & Expense Waterfall</div>
      <table class="wf-table">
        <tr><td>Gross Monthly Income</td><td>$${f(grossMonthly)}</td></tr>
        <tr><td>√ó 12 Months</td><td>$${f(grossAnnual)}</td></tr>
        <tr><td>Less: Vacancy (${vacancy}%)</td><td style="color:#f76e6e;">‚àí$${f(vacancyLoss)}</td></tr>
        <tr><td>Effective Gross Income</td><td style="color:#4f8ef7;">$${f(effectiveGross)}</td></tr>
        <tr><td>Less: Total Expenses (${expRatio.toFixed(0)}%)</td><td style="color:#f76e6e;">‚àí$${f(totalExpenses)}</td></tr>
        <tr class="wf-total"><td>Net Operating Income</td><td style="color:#38d9a9;">$${f(noi)}</td></tr>
        ${debtEnabled?`<tr><td>Less: Annual Debt Service</td><td style="color:#f76e6e;">‚àí$${f(annualDebt)}</td></tr>
        <tr class="wf-total"><td>Cash Flow Before Tax</td><td style="color:${cashFlow>=0?'#38d9a9':'#f76e6e'};">${cashFlow>=0?'+':'-'}$${f(Math.abs(cashFlow))}</td></tr>`:''}
      </table>
    </div>

    <!-- Rent Roll -->
    <div>
      <div class="section-title">Rent Roll</div>
      <table>
        <tr><th>#</th><th>Type</th><th>Current</th><th>Year 2</th><th>Annual</th></tr>
        ${rentRows}
        <tr style="background:#1a1f2a;"><td colspan="2" style="color:#8892a4;">Total</td><td style="color:#4f8ef7;">$${f(monthlyRent)}/mo</td><td></td><td style="color:#4f8ef7;">$${f(monthlyRent*12)}</td></tr>
      </table>

      ${debtEnabled?`
      <div class="section-title" style="margin-top:16px;">Debt Assumptions</div>
      <table>
        <tr><td>Asking Price</td><td style="text-align:right;color:#4f8ef7;">$${f(price)}</td></tr>
        <tr><td>Down Payment (${downPct}%)</td><td style="text-align:right;color:#f7c948;">$${f(downPayment)}</td></tr>
        <tr><td>Loan Amount</td><td style="text-align:right;color:#4f8ef7;">$${f(loanAmt)}</td></tr>
        <tr><td>Interest Rate</td><td style="text-align:right;">${intRate}%</td></tr>
        <tr><td>Amortization</td><td style="text-align:right;">${amortYears} years</td></tr>
        <tr><td>Monthly Payment</td><td style="text-align:right;color:#f7c948;">$${f(monthlyPayment)}</td></tr>
      </table>`:''}
    </div>
  </div>

  <!-- Expenses -->
  <div class="section-title">Expense Detail</div>
  <table style="margin-bottom:24px;">
    <tr><th>Expense</th><th style="text-align:right;">Annual Amount</th></tr>
    ${expenseRows}
    <tr class="wf-total"><td>Total Expenses</td><td style="text-align:right;color:#f76e6e;">$${f(totalExpenses)}</td></tr>
  </table>

  <div class="footer">
    <div class="footer-logo">Pocket<span>Broker</span></div>
    <div class="footer-note">Built by @TheGoogleGrad &nbsp;¬∑&nbsp; Generated ${today} &nbsp;¬∑&nbsp; pocketbroker.app</div>
  </div>
</body>
</html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  setTimeout(() => win.print(), 800);
}

// ‚îÄ‚îÄ COMPS ‚îÄ‚îÄ
let comps = [];
let compId = 0;

function addComp() {
  comps.push({ id: ++compId, address: '', units: '', price: '', capRate: '', bldgSF: '', landSF: '', notes: '' });
  renderComps();
}

function removeComp(id) {
  comps = comps.filter(c => c.id !== id);
  renderComps();
}

function toggleCompNotes(id) {
  const el = document.getElementById('comp-notes-' + id);
  const btn = document.getElementById('comp-notes-btn-' + id);
  if (!el) return;
  const open = el.style.display === 'none' || el.style.display === '';
  el.style.display = open ? 'block' : 'none';
  if (btn) btn.textContent = open ? '‚ñ≤ Notes' : '‚ñº Notes';
}

function updateCompCalcs(id) {
  const c = comps.find(x => x.id === id);
  const el = document.getElementById('comp-calcs-' + id);
  if (!c || !el) return;
  const price = parseFloat((c.price||'').replace(/,/g,'')) || 0;
  const numUnits = parseFloat(c.units) || 0;
  const bldgSF = parseFloat(c.bldgSF) || 0;
  const landSF = parseFloat(c.landSF) || 0;
  const ppu = price && numUnits ? '$'+Math.round(price/numUnits).toLocaleString() : '';
  const ppb = price && bldgSF ? '$'+Math.round(price/bldgSF).toLocaleString() : '';
  const ppl = price && landSF ? '$'+Math.round(price/landSF).toLocaleString() : '';
  el.innerHTML = `
    <div style="background:var(--surface2);border-radius:6px;padding:5px 8px;">
      <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:2px;">$ / Unit</div>
      <div style="font-family:var(--mono);font-size:11px;font-weight:600;color:var(--accent3);">${ppu || '‚Äî'}</div>
    </div>
    <div style="background:var(--surface2);border-radius:6px;padding:5px 8px;">
      <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:2px;">$ / Bldg SF</div>
      <div style="font-family:var(--mono);font-size:11px;font-weight:600;color:var(--accent);">${ppb || '‚Äî'}</div>
    </div>
    <div style="background:var(--surface2);border-radius:6px;padding:5px 8px;">
      <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:2px;">$ / Land SF</div>
      <div style="font-family:var(--mono);font-size:11px;font-weight:600;color:var(--accent2);">${ppl || '‚Äî'}</div>
    </div>`;
  // Also update summary
  renderCompSummary();
}

function renderCompSummary() {
  const summary = document.getElementById('comps-summary');
  if (!summary) return;
  const withPrice = comps.filter(c => c.price);
  const withCap = comps.filter(c => c.capRate);
  const withUnits = comps.filter(c => c.price && c.units);
  if (withPrice.length === 0 && withCap.length === 0) { summary.style.display='none'; return; }
  const avgPrice = withPrice.length ? withPrice.reduce((s,c)=>s+parseFloat((c.price||'').replace(/,/g,'')),0)/withPrice.length : null;
  const avgCap = withCap.length ? withCap.reduce((s,c)=>s+parseFloat(c.capRate),0)/withCap.length : null;
  const avgPPU = withUnits.length ? withUnits.reduce((s,c)=>s+parseFloat((c.price||'').replace(/,/g,''))/parseFloat(c.units),0)/withUnits.length : null;
  const subjectPrice = parseFloat(document.getElementById('prop-price')?.value?.replace(/,/g,''))||0;
  const subjectPPU = subjectPrice && units.length ? subjectPrice/units.length : null;
  summary.style.display = 'block';
  summary.innerHTML = `
    <div style="padding:12px 16px;background:var(--surface2);border-top:2px solid var(--border);">
      <div style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px;">Comp Averages vs Subject</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;">
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Avg Cap Rate</div>
          <div style="font-family:var(--display);font-weight:800;font-size:18px;color:var(--accent2);">${avgCap ? avgCap.toFixed(2)+'%' : '‚Äî'}</div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;">
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Avg Sale Price</div>
          <div style="font-family:var(--display);font-weight:800;font-size:18px;color:var(--accent);">${avgPrice ? '$'+Math.round(avgPrice).toLocaleString() : '‚Äî'}</div>
          ${subjectPrice ? '<div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:2px;">Subject: <span style="color:var(--accent);">$'+subjectPrice.toLocaleString()+'</span></div>' : ''}
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;">
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Avg $/Unit</div>
          <div style="font-family:var(--display);font-weight:800;font-size:18px;color:var(--accent3);">${avgPPU ? '$'+Math.round(avgPPU).toLocaleString() : '‚Äî'}</div>
          ${subjectPPU ? '<div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:2px;">Subject: <span style="color:var(--accent3);">$'+Math.round(subjectPPU).toLocaleString()+'</span></div>' : ''}
        </div>
      </div>
    </div>`;
}

function renderComps() {
  const list = document.getElementById('comps-list');
  const header = document.getElementById('comps-header');
  const summary = document.getElementById('comps-summary');
  const badge = document.getElementById('comps-count-badge');
  if (!list) return;

  badge.textContent = comps.length + ' comp' + (comps.length !== 1 ? 's' : '');

  if (comps.length === 0) {
    list.innerHTML = '<div style="padding:24px 16px;text-align:center;font-family:var(--mono);font-size:12px;color:var(--text3);">No comps added yet</div>';
    header.style.display = 'none';
    summary.style.display = 'none';
    return;
  }

  header.style.display = 'block';

  list.innerHTML = comps.map((c, i) => {
    const idx = comps.indexOf(c);
    const price = parseFloat((c.price||'').replace(/,/g,'')) || 0;
    const numUnits = parseFloat(c.units) || 0;
    const bldgSF = parseFloat(c.bldgSF) || 0;
    const landSF = parseFloat(c.landSF) || 0;
    const pricePerUnit = price && numUnits ? Math.round(price / numUnits) : null;
    const pricePerBldg = price && bldgSF ? Math.round(price / bldgSF) : null;
    const pricePerLand = price && landSF ? Math.round(price / landSF) : null;
    const hasNotes = c.notes && c.notes.trim().length > 0;
    return `
    <div style="border-bottom:1px solid var(--border);">
      <!-- Main row -->
      <div style="padding:10px 16px;">
        <div style="display:grid;grid-template-columns:1fr 60px 80px 60px 24px;gap:6px;align-items:center;margin-bottom:6px;">
          <input type="text" placeholder="123 Main St, City" value="${c.address}"
            style="background:#ffffff;border:1px solid var(--border);border-radius:6px;padding:6px 8px;
                   font-family:var(--mono);font-size:11px;color:#1a1f2e;outline:none;width:100%;"
            oninput="comps[${idx}].address=this.value" />
          <input type="number" placeholder="Units" value="${c.units}"
            style="background:#ffffff;border:1px solid var(--border);border-radius:6px;padding:6px 4px;
                   font-family:var(--mono);font-size:11px;color:#1a1f2e;outline:none;width:100%;text-align:center;"
            oninput="comps[${idx}].units=this.value;renderComps()" />
          <div style="position:relative;">
            <span style="position:absolute;left:6px;top:50%;transform:translateY(-50%);font-family:var(--mono);font-size:10px;color:var(--text3);">$</span>
            <input type="text" placeholder="1,200,000" value="${c.price}"
              style="background:#ffffff;border:1px solid rgba(79,142,247,0.3);border-radius:6px;padding:6px 4px 6px 14px;
                     font-family:var(--mono);font-size:11px;color:#1a1f2e;outline:none;width:100%;"
              oninput="comps[${idx}].price=this.value;renderComps()" />
          </div>
          <div style="position:relative;">
            <input type="number" placeholder="5.0" step="0.01" value="${c.capRate}"
              style="background:#ffffff;border:1px solid rgba(56,217,169,0.3);border-radius:6px;padding:6px 14px 6px 6px;
                     font-family:var(--mono);font-size:11px;color:#1a1f2e;outline:none;width:100%;text-align:center;"
              oninput="comps[${idx}].capRate=this.value;renderComps()" />
            <span style="position:absolute;right:4px;top:50%;transform:translateY(-50%);font-family:var(--mono);font-size:9px;color:var(--text3);">%</span>
          </div>
          <button onclick="removeComp(${c.id})" style="background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:0;line-height:1;">√ó</button>
        </div>
        <!-- SF row -->
        <div style="display:grid;grid-template-columns:80px 80px 1fr auto;gap:6px;align-items:end;">
          <div>
            <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:3px;">Bldg SF</div>
            <input type="number" placeholder="4,500" value="${c.bldgSF||''}"
              style="background:#ffffff;border:1px solid var(--border);border-radius:6px;padding:5px 4px 5px 8px;
                     font-family:var(--mono);font-size:10px;color:#1a1f2e;outline:none;width:100%;"
              oninput="comps[${idx}].bldgSF=this.value;updateCompCalcs(${c.id})" />
          </div>
          <div>
            <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:3px;">Land SF</div>
            <input type="number" placeholder="6,000" value="${c.landSF||''}"
              style="background:#ffffff;border:1px solid var(--border);border-radius:6px;padding:5px 4px 5px 8px;
                     font-family:var(--mono);font-size:10px;color:#1a1f2e;outline:none;width:100%;"
              oninput="comps[${idx}].landSF=this.value;updateCompCalcs(${c.id})" />
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;" id="comp-calcs-${c.id}">
            <div style="background:var(--surface2);border-radius:6px;padding:5px 8px;">
              <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:2px;">$ / Unit</div>
              <div style="font-family:var(--mono);font-size:11px;font-weight:600;color:var(--accent3);">${pricePerUnit ? '$'+pricePerUnit.toLocaleString() : '‚Äî'}</div>
            </div>
            <div style="background:var(--surface2);border-radius:6px;padding:5px 8px;">
              <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:2px;">$ / Bldg SF</div>
              <div style="font-family:var(--mono);font-size:11px;font-weight:600;color:var(--accent);">${pricePerBldg ? '$'+pricePerBldg.toLocaleString() : '‚Äî'}</div>
            </div>
            <div style="background:var(--surface2);border-radius:6px;padding:5px 8px;">
              <div style="font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text3);margin-bottom:2px;">$ / Land SF</div>
              <div style="font-family:var(--mono);font-size:11px;font-weight:600;color:var(--accent2);">${pricePerLand ? '$'+pricePerLand.toLocaleString() : '‚Äî'}</div>
            </div>
          </div>
          <button id="comp-notes-btn-${c.id}" onclick="toggleCompNotes(${c.id})"
            style="background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;
                   font-family:var(--mono);font-size:9px;color:${hasNotes ? 'var(--accent)' : 'var(--text3)'};cursor:pointer;white-space:nowrap;align-self:flex-end;">
            ‚ñº Notes
          </button>
        </div>
      </div>
      <!-- Collapsible notes -->
      <div id="comp-notes-${c.id}" style="display:none;padding:0 16px 12px;">
        <textarea placeholder="Notes about this comp ‚Äî source, date, condition, broker, etc."
          style="width:100%;min-height:72px;background:#ffffff;border:1px solid var(--border);border-radius:6px;
                 padding:8px;font-family:var(--mono);font-size:11px;color:#1a1f2e;resize:vertical;outline:none;"
          oninput="comps[${idx}].notes=this.value;const btn=document.getElementById('comp-notes-btn-${c.id}');if(btn)btn.style.color=this.value.trim()?'var(--accent)':'var(--text3)'"
          onfocus="this.style.borderColor='var(--accent)'"
          onblur="this.style.borderColor='var(--border)'">${c.notes||''}</textarea>
      </div>
    </div>`;
  }).join('');

  // Summary averages
  const withPrice = comps.filter(c => c.price);
  const withCap = comps.filter(c => c.capRate);
  const withUnits = comps.filter(c => c.price && c.units);
  const avgPrice = withPrice.length ? withPrice.reduce((s,c) => s + parseFloat(c.price.replace(/,/g,'')), 0) / withPrice.length : null;
  const avgCap = withCap.length ? withCap.reduce((s,c) => s + parseFloat(c.capRate), 0) / withCap.length : null;
  const avgPPU = withUnits.length ? withUnits.reduce((s,c) => s + parseFloat(c.price.replace(/,/g,''))/parseFloat(c.units), 0) / withUnits.length : null;

  // Subject deal values for comparison
  const subjectPrice = parseFloat(document.getElementById('prop-price')?.value?.replace(/,/g,'')) || 0;
  const subjectUnits = units.length || 0;
  const subjectPPU = subjectPrice && subjectUnits ? subjectPrice / subjectUnits : null;

  summary.style.display = 'block';
  summary.innerHTML = `
    <div style="padding:12px 16px;background:var(--surface2);border-top:2px solid var(--border);">
      <div style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:10px;">Comp Averages vs Subject</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;">
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Avg Cap Rate</div>
          <div style="font-family:var(--display);font-weight:800;font-size:18px;color:var(--accent2);">${avgCap ? avgCap.toFixed(2)+'%' : '‚Äî'}</div>
          ${subjectPrice ? `<div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:2px;">Subject: <span style="color:var(--accent);">${avgCap ? ((parseFloat(document.getElementById('prop-price')?.value?.replace(/,/g,''))||0) > 0 ? '‚Äî' : '‚Äî') : '‚Äî'}</span></div>` : ''}
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;">
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Avg Sale Price</div>
          <div style="font-family:var(--display);font-weight:800;font-size:18px;color:var(--accent);">${avgPrice ? '$'+Math.round(avgPrice).toLocaleString() : '‚Äî'}</div>
          ${subjectPrice ? `<div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:2px;">Subject: <span style="color:var(--accent);">$${subjectPrice.toLocaleString()}</span></div>` : ''}
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;">
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Avg $/Unit</div>
          <div style="font-family:var(--display);font-weight:800;font-size:18px;color:var(--accent3);">${avgPPU ? '$'+Math.round(avgPPU).toLocaleString() : '‚Äî'}</div>
          ${subjectPPU ? `<div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:2px;">Subject: <span style="color:var(--accent3);">$${Math.round(subjectPPU).toLocaleString()}</span></div>` : ''}
        </div>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ SAVE / LOAD DEAL ‚îÄ‚îÄ
function saveDeal() {
  const addr = document.getElementById('prop-address')?.value || 'deal';
  const city = document.getElementById('prop-city')?.value || '';
  const slug = [addr, city].filter(Boolean).join('-').replace(/[^a-z0-9]/gi, '_').toLowerCase();
  const filename = `pocketbroker_${slug}_${new Date().toISOString().slice(0,10)}.json`;

  const data = {
    version: 1,
    savedAt: new Date().toISOString(),
    property: {
      address: document.getElementById('prop-address')?.value || '',
      city:    document.getElementById('prop-city')?.value || '',
      zip:     document.getElementById('prop-zip')?.value || '',
      state:   document.getElementById('prop-state')?.value || '',
      year:    document.getElementById('prop-year')?.value || '',
      bldgSF:  document.getElementById('prop-bldg-sf')?.value || '',
      landSF:  document.getElementById('prop-land-sf')?.value || '',
      price:   document.getElementById('prop-price')?.value || '',
    },
    units: units.map(u => ({ type: u.type, rent: u.rent, rent2: u.rent2, rent3: u.rent3 })),
    income: {
      vacancy:  document.getElementById('vacancy-rate')?.value || '',
      laundry:  document.getElementById('laundry-income')?.value || '',
      parking:  document.getElementById('parking-income')?.value || '',
    },
    expenses: {
      defaults: defaultExpenses.map(e => ({ id: e.id, value: e.value, on: e.on })),
      custom: customExpenses.map(e => ({ name: e.name, value: e.value })),
    },
    debt: {
      enabled:  debtEnabled,
      downPct:  document.getElementById('down-pct')?.value || '',
      intRate:  document.getElementById('int-rate')?.value || '',
      amort:    document.getElementById('amort-years')?.value || '',
    },
    rentRoll: {
      applyYr2: document.getElementById('apply-all-yr2')?.checked || false,
      applyYr3: document.getElementById('apply-all-yr3')?.checked || false,
      pct:      document.getElementById('global-yr2-pct')?.value || '5',
    },
    analysisDate: document.getElementById('analysis-date')?.value || '',
    comps: comps.map(c => ({ address: c.address, units: c.units, price: c.price, capRate: c.capRate, bldgSF: c.bldgSF||'', landSF: c.landSF||'', notes: c.notes||'' })),
    notes: document.getElementById('deal-notes')?.value || '',
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function loadDeal(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const d = JSON.parse(e.target.result);
      if (!d.version) throw new Error('Invalid file');

      // Property
      if (d.property) {
        document.getElementById('prop-address').value = d.property.address || '';
        document.getElementById('prop-city').value    = d.property.city || '';
        document.getElementById('prop-zip').value     = d.property.zip || '';
        document.getElementById('prop-state').value   = d.property.state || '';
        document.getElementById('prop-year').value    = d.property.year || '';
        document.getElementById('prop-bldg-sf').value = d.property.bldgSF || '';
        document.getElementById('prop-land-sf').value = d.property.landSF || '';
        document.getElementById('prop-price').value   = d.property.price || '';
      }

      // Units
      units = [];
      unitId = 0;
      if (d.units) {
        d.units.forEach(u => {
          units.push({ id: ++unitId, type: u.type || '', rent: u.rent || '', rent2: u.rent2 || '', rent3: u.rent3 || '' });
        });
      }

      // Income
      if (d.income) {
        document.getElementById('vacancy-rate').value  = d.income.vacancy || '5';
        document.getElementById('laundry-income').value = d.income.laundry || '0';
        document.getElementById('parking-income').value = d.income.parking || '0';
      }

      // Expenses
      if (d.expenses?.defaults) {
        d.expenses.defaults.forEach(saved => {
          const exp = defaultExpenses.find(e => e.id === saved.id);
          if (exp) { exp.value = saved.value; exp.on = saved.on; }
        });
      }
      customExpenses = [];
      customId = 0;
      if (d.expenses?.custom) {
        d.expenses.custom.forEach(c => {
          customExpenses.push({ id: ++customId, name: c.name, value: c.value });
        });
      }

      // Debt
      if (d.debt) {
        debtEnabled = d.debt.enabled;
        document.getElementById('down-pct').value   = d.debt.downPct || '25';
        document.getElementById('int-rate').value   = d.debt.intRate || '6.5';
        document.getElementById('amort-years').value = d.debt.amort || '30';
        renderDebtToggle();
      }

      // Rent roll checkboxes
      if (d.rentRoll) {
        document.getElementById('apply-all-yr2').checked = d.rentRoll.applyYr2;
        document.getElementById('apply-all-yr3').checked = d.rentRoll.applyYr3;
        document.getElementById('global-yr2-pct').value  = d.rentRoll.pct || '5';
      }

      // Analysis date
      if (d.analysisDate) {
        const adEl = document.getElementById('analysis-date');
        if (adEl) adEl.value = d.analysisDate;
      }

      // Comps
      comps = [];
      compId = 0;
      if (d.comps) {
        d.comps.forEach(c => {
          comps.push({ id: ++compId, address: c.address||'', units: c.units||'', price: c.price||'', capRate: c.capRate||'', bldgSF: c.bldgSF||'', landSF: c.landSF||'', notes: c.notes||'' });
        });
      }
      renderComps();
      // Notes
      const notesEl = document.getElementById('deal-notes');
      if (notesEl && d.notes) notesEl.value = d.notes;

      renderDefaultExpenses();
      renderUnits();
      calculate();

      // Flash confirmation
      const btn = event.target.closest('label');
      if (btn) {
        const orig = btn.style.color;
        btn.style.color = 'var(--accent2)';
        btn.childNodes[0].textContent = '‚úì Loaded';
        setTimeout(() => { btn.childNodes[0].textContent = 'üìÇ Load'; btn.style.color = orig; }, 1500);
      }
      // Reset file input so same file can be reloaded
      event.target.value = '';
    } catch(err) {
      alert('Could not load file. Make sure it\'s a valid PocketBroker JSON.');
    }
  };
  reader.readAsText(file);
}

function copySnapshot() {
  const addr = document.getElementById('prop-address').value || 'Property';
  const price = document.getElementById('prop-price').value.replace(/,/g, '');
  const noi = document.getElementById('results-content').querySelector('.result-card.green .result-value')?.textContent;
  const cap = document.getElementById('results-content').querySelector('.result-card.blue .result-value')?.textContent;
  const grm = document.getElementById('results-content').querySelector('.result-card.gold .result-value')?.textContent;

  const lines = [
    `üìä DEAL SNAPSHOT ‚Äî ${addr}`,
    `Asking: $${price ? Number(price).toLocaleString() : 'N/A'}`,
    `NOI: ${noi || '‚Äî'}`,
    `Cap Rate: ${cap || '‚Äî'}`,
    `GRM: ${grm || '‚Äî'}`,
    `Units: ${units.length}`,
    `Monthly Rent: $${fmt(units.reduce((s,u) => s + (parseFloat(u.rent)||0), 0))}`,
    `Generated by PocketBroker`
  ];

  navigator.clipboard.writeText(lines.join('\n')).then(() => showToast('‚úì Snapshot copied!'));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function resetAll() {
  if (!confirm('Reset all data?')) return;
  units = []; unitId = 0; customExpenses = []; customId = 0; debtEnabled = false;
  document.getElementById('prop-address').value = '';
  document.getElementById('prop-city').value = '';
  document.getElementById('prop-price').value = '';
  document.getElementById('prop-zip').value = '';
  document.getElementById('prop-state').value = '';
  document.getElementById('prop-year').value = '';
  document.getElementById('prop-bldg-sf').value = '';
  document.getElementById('prop-land-sf').value = '';
  document.getElementById('laundry-income').value = '';
  document.getElementById('parking-income').value = '';
  document.getElementById('vacancy-rate').value = '5';
  defaultExpenses.forEach(e => {
    if (['taxes','insurance','mgmt','repairs','reserves'].includes(e.id)) e.on = true;
    else e.on = false;
  });
  init();
  switchTab('income');
  showToast('‚Ü∫ Reset complete');
}

init();
renderCustomExpenses();
</script>
<script>
// ‚îÄ‚îÄ PASSWORD ‚îÄ‚îÄ
(function() {
  const HASH = '7f7d40a3e9a9c6d8b1f2e4a5c3d6b8e2f1a4c7d9e0b3f5a2c8d1e6b4f7a0c3';
  // Simple check ‚Äî compare against stored session
  if (sessionStorage.getItem('pb_auth') === '1') {
    document.getElementById('pw-screen').classList.add('hidden');
  }
})();

function checkPassword() {
  const val = document.getElementById('pw-input').value;
  const input = document.getElementById('pw-input');
  const err = document.getElementById('pw-error');
  if (val === 'Moneyteam') {
    sessionStorage.setItem('pb_auth', '1');
    document.getElementById('pw-screen').classList.add('hidden');
    err.textContent = '';
  } else {
    input.classList.add('error');
    err.textContent = 'Incorrect password. Try again.';
    setTimeout(() => input.classList.remove('error'), 400);
    input.value = '';
    input.focus();
  }
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('pocketbroker-sw.js').then(reg => {
      console.log('PocketBroker SW registered');
    }).catch(err => console.log('SW registration failed:', err));
  });
}
</script>
</body>
</html>
